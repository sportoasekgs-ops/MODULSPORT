{"file_contents":{"replit.md":{"content":"# SportOase - IServ Sports Facility Booking Module\n\n## Project Overview\nSportOase is a complete IServ module for booking sports facilities (e.g., gym halls) within schools. Built with Django backend and Angular frontend, it integrates seamlessly into IServ's platform using native authentication and permissions.\n\n**Status**: Development complete, CSRF security verified, ready for deployment testing\n\n## Architecture\n\n### Backend (Django)\n- **Framework**: Django 4.2.7 with Django REST Framework\n- **Database**: SQLite (development), MariaDB-compatible models for production IServ\n- **Authentication**: Uses IServ's native `request.user` system (no separate user database)\n- **Permissions**: \n  - `sportoase.user` - Teachers can book available slots\n  - `sportoase.admin` - Administrators can block slots and view all bookings\n\n### Frontend (Angular)\n- **Framework**: Angular 17\n- **Routing**: Six main views (Dashboard, Week Overview, Slots, Bookings, My Bookings, Admin)\n- **Security**: CSRF tokens with withCredentials for all API calls\n- **Development**: Test login system (testuser/test123) for local development\n\n### Models\n1. **TimeSlot** - Defines available booking periods (day + period number)\n2. **Booking** - Links user to timeslot with purpose and teacher info\n3. **BlockedSlot** - Administrative blocks for maintenance/events\n4. **Notification** - System notifications for administrators\n\n## Recent Changes (November 20, 2025)\n\n### Week Overview Feature Added (Latest)\n**Status**: Fully functional week overview component\n\n**New Features**:\n1. **Week Overview Component** - Calendar-style view showing all slots for the week\n   - Grid layout displaying Monday through Friday\n   - Each day shows all 6 periods with availability status\n   - Color-coded slots: Green (available), Yellow (almost full), Red (blocked)\n   - Progress bars showing booking capacity\n   - Navigation buttons: Previous Week, Current Week, Next Week\n   - Click slots to navigate directly to booking form\n\n2. **API Endpoint** - `GET /api/sportoase/slots/week?start_date=YYYY-MM-DD`\n   - Returns structured week data with all slots and their booking status\n   - Automatically defaults to current week if no start_date provided\n\n3. **Development Login System**\n   - Added login component for local testing\n   - Test user credentials: `testuser` / `test123`\n   - Login endpoints: `/api/sportoase/login`, `/api/sportoase/logout`, `/api/sportoase/check-auth`\n   - User has both `sportoase.user` and `sportoase.admin` permissions for testing\n\n**Files Added/Modified**:\n- `frontend/src/app/components/week-overview/week-overview.component.ts` - New week overview component\n- `frontend/src/app/components/login/login.component.ts` - New login component\n- `backend/views/auth.py` - Authentication endpoints for development\n- `backend/views/slots.py` - Week overview endpoint\n- `frontend/src/app/services/api.service.ts` - Added getWeekOverview method\n- `backend/urls.py` - Added login/logout/check-auth routes\n\n### IServ Production Deployment Configuration\n**Status**: Ready for live IServ deployment\n\n**New Files Added**:\n1. `backend/settings_prod.py` - Production Django settings with MariaDB support\n2. `backend/middleware/iserv_auth.py` - IServ authentication middleware\n3. `deploy_iserv.sh` - Automated deployment script\n4. `README_DEPLOYMENT.md` - Comprehensive deployment guide\n5. `.env.example` - Environment configuration template\n\n**Configuration Features**:\n- **Database**: MariaDB/MySQL support for production IServ environments\n- **Authentication**: IServ native auth integration via middleware\n- **Security**: Production-ready HTTPS, secure cookies, CSRF protection\n- **Deployment**: Automated build script and systemd service configuration\n- **Frontend**: Angular production build with `/sportoase/` base path\n\n**Environment Variables**:\nThe application now supports full environment-based configuration for IServ deployment, including database settings, domain configuration, and security options.\n\n**Deployment Process**:\n1. Run `./deploy_iserv.sh` to build production package\n2. Copy to IServ server\n3. Configure environment variables\n4. Run migrations and collect static files\n5. Configure Apache proxy and systemd service\n\nSee `README_DEPLOYMENT.md` for complete deployment instructions.\n\n### Critical Security Fix - CSRF Protection\n**Problem**: Initial implementation had `@csrf_exempt` decorators on all state-changing endpoints, creating a critical security vulnerability.\n\n**Solution Implemented**:\n1. Removed all `@csrf_exempt` decorators from views (create_booking, delete_booking, block_slot, unblock_slot, mark_notification_read)\n2. Added CSRF token endpoint: `GET /api/sportoase/csrf`\n3. Updated Angular API service to fetch and attach CSRF tokens to all requests\n4. Added `withCredentials: true` to all HTTP calls for cookie transmission\n5. Configured Django settings:\n   - `CSRF_COOKIE_HTTPONLY = True`\n   - `CSRF_COOKIE_SAMESITE = 'Lax'`\n   - `CORS_ALLOW_CREDENTIALS = True`\n   - Proper CORS and CSRF trusted origins\n\n**Verification**: Architect review confirmed all CSRF vulnerabilities resolved and implementation is production-ready.\n\n## Project Structure\n\n```\n/\n├── backend/\n│   ├── models.py              # Django ORM models\n│   ├── settings.py            # Django configuration\n│   ├── main_urls.py           # Root URL configuration\n│   ├── urls.py                # SportOase API routes\n│   ├── views/\n│   │   ├── slots.py           # Slot availability views (incl. week overview)\n│   │   ├── bookings.py        # Booking CRUD operations\n│   │   ├── admin.py           # Admin blocking and notifications\n│   │   ├── csrf.py            # CSRF token endpoint\n│   │   └── auth.py            # Development authentication endpoints\n│   ├── services/\n│   │   └── booking_service.py # Business logic layer\n│   ├── manage.py              # Django management\n│   └── init_data.py           # Creates 30 initial timeslots\n├── frontend/\n│   └── src/app/\n│       ├── components/\n│       │   ├── dashboard/         # Main dashboard\n│       │   ├── week-overview/     # Week calendar view\n│       │   ├── slots/             # Slot browser\n│       │   ├── booking-form/      # Create bookings\n│       │   ├── my-bookings/       # User's bookings\n│       │   ├── admin-panel/       # Admin tools\n│       │   └── login/             # Dev login (testing only)\n│       └── services/\n│           └── api.service.ts # HTTP client with CSRF handling\n├── module.json                # IServ module configuration\n└── db.sqlite3                 # Development database\n```\n\n## API Endpoints\n\n### Public Endpoints\n- `GET /api/sportoase/csrf` - Get CSRF token\n- `GET /api/sportoase/slots?date=YYYY-MM-DD` - Available slots for specific date\n- `GET /api/sportoase/slots/week?start_date=YYYY-MM-DD` - Week overview (Monday-Friday)\n- `GET /api/sportoase/timeslots` - All timeslots\n\n### Development Endpoints (for local testing only)\n- `POST /api/sportoase/login` - Login with username/password\n- `POST /api/sportoase/logout` - Logout current user\n- `GET /api/sportoase/check-auth` - Check authentication status\n\n### User Endpoints (requires sportoase.user)\n- `POST /api/sportoase/book` - Create booking\n- `GET /api/sportoase/my-bookings` - User's bookings\n- `DELETE /api/sportoase/bookings/{id}` - Delete own booking\n\n### Admin Endpoints (requires sportoase.admin)\n- `POST /api/sportoase/block-slot` - Block a timeslot\n- `POST /api/sportoase/unblock-slot` - Unblock a timeslot\n- `GET /api/sportoase/blocked-slots` - List blocked slots\n- `GET /api/sportoase/bookings` - All bookings\n- `GET /api/sportoase/notifications` - System notifications\n\n## Initial Data\nThe database comes pre-populated with 30 timeslots:\n- **Days**: Monday through Friday\n- **Periods**: 1-6 (08:00-13:35)\n- Configured in `backend/settings.py` under `PERIOD_TIMES`\n\n## Development Environment\n- **Workflow**: Django Backend running on `0.0.0.0:5000`\n- **Database**: SQLite at `db.sqlite3`\n- **Migrations**: Applied and up-to-date\n\n## Deployment to IServ\n\n### Quick Start\n\n```bash\n# 1. Build the deployment package\n./deploy_iserv.sh\n\n# 2. Transfer to IServ server\nscp -r build/ admin@your-school.iserv.de:/tmp/sportoase\n\n# 3. Follow detailed instructions in README_DEPLOYMENT.md\n```\n\n### Key Configuration Files\n\n- **`backend/settings_prod.py`**: Production Django settings\n- **`.env.example`**: Environment variable template\n- **`deploy_iserv.sh`**: Automated deployment build script\n- **`README_DEPLOYMENT.md`**: Complete deployment guide with:\n  - Database setup (MariaDB)\n  - Apache/Nginx proxy configuration\n  - Systemd service setup\n  - IServ authentication integration\n  - Troubleshooting guide\n\n### Environment Variables (Production)\n\n```bash\nISERV_DOMAIN=your-school.iserv.de\nISERV_AUTH_ENABLED=True\nDJANGO_SETTINGS_MODULE=backend.settings_prod\nDB_ENGINE=mysql\nDB_NAME=iserv_sportoase\nDB_USER=sportoase\nDB_PASSWORD=<secure-password>\nDJANGO_SECRET_KEY=<secure-key>\nDEBUG=False\nHTTPS=True\n```\n\n### IServ Authentication\n\nThe middleware (`backend/middleware/iserv_auth.py`) integrates with IServ by:\n- Reading IServ user headers (`X-IServ-User`, `X-IServ-Email`, etc.)\n- Auto-creating/updating Django users\n- Syncing IServ groups to Django permissions\n- Mapping `lehrer`/`teachers` → `sportoase.user`\n- Mapping `admin`/`administrators` → `sportoase.admin`\n\n### Deployment Checklist\n\n- [ ] Run `./deploy_iserv.sh` to create build package\n- [ ] Copy build to IServ server\n- [ ] Create MariaDB database and user\n- [ ] Configure environment variables in `/etc/iserv/sportoase.env`\n- [ ] Run migrations: `python backend/manage.py migrate --settings=backend.settings_prod`\n- [ ] Initialize timeslots: `python backend/init_data.py`\n- [ ] Configure Apache/Nginx proxy\n- [ ] Set up systemd service\n- [ ] Register IServ permissions: `sportoase.user` and `sportoase.admin`\n- [ ] Test authentication and permissions\n- [ ] Verify booking flow works end-to-end\n\n## Security Features\n- ✅ CSRF protection on all state-changing operations\n- ✅ Django's built-in authentication via `request.user`\n- ✅ IServ permission system integration\n- ✅ Secure cookie handling with HttpOnly flags\n- ✅ CORS configured for credential transmission\n- ✅ No hardcoded credentials or secrets\n\n## Known Limitations\n- Currently configured for development (DEBUG=True, SQLite)\n- Angular frontend needs to be built and served separately (not integrated into Django static files)\n- Docker configuration pending (task 9 not yet started)\n\n## Future Enhancements\n- Docker containerization for easier deployment\n- Email notifications for booking confirmations\n- Recurring bookings (weekly patterns)\n- Calendar view integration\n- Conflict detection and warnings\n","size_bytes":10938},"frontend/src/app/components/slots/slots.component.ts":{"content":"import { Component, OnInit } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { ApiService } from '../../services/api.service';\n\n@Component({\n  selector: 'app-slots',\n  template: `\n    <div class=\"card\">\n      <h2>Verfügbare Slots</h2>\n      \n      <div class=\"mb-3\">\n        <label for=\"dateSelect\" class=\"form-label\">Datum wählen:</label>\n        <input \n          type=\"date\" \n          class=\"form-control\" \n          id=\"dateSelect\" \n          [(ngModel)]=\"selectedDate\"\n          (change)=\"loadSlots()\">\n      </div>\n      \n      <div *ngIf=\"loading\" class=\"loading-container\">\n        <div class=\"spinner-border text-primary\" role=\"status\">\n          <span class=\"visually-hidden\">Laden...</span>\n        </div>\n      </div>\n      \n      <div *ngIf=\"!loading && slots.length > 0\">\n        <div *ngFor=\"let slot of slots\" \n             class=\"card mb-2\" \n             [ngClass]=\"getSlotClass(slot)\">\n          <div class=\"card-body\">\n            <div class=\"d-flex justify-content-between align-items-center\">\n              <div>\n                <h5>{{ slot.period }}. Stunde: {{ slot.label }}</h5>\n                <p class=\"mb-1\">{{ slot.start_time }} - {{ slot.end_time }}</p>\n                <p class=\"mb-0\">\n                  <span *ngIf=\"!slot.is_blocked\">\n                    <strong>{{ slot.current_students }}</strong> / {{ slot.max_students }} Schüler\n                    ({{ slot.available_spots }} Plätze frei)\n                  </span>\n                  <span *ngIf=\"slot.is_blocked\" class=\"text-danger\">\n                    <strong>Blockiert:</strong> {{ slot.blocked_reason }}\n                  </span>\n                </p>\n              </div>\n              <div>\n                <button \n                  *ngIf=\"slot.is_available && !slot.is_blocked\" \n                  class=\"btn btn-primary\"\n                  (click)=\"bookSlot(slot)\">\n                  Buchen\n                </button>\n                <span *ngIf=\"slot.is_blocked\" class=\"badge bg-danger\">Blockiert</span>\n                <span *ngIf=\"!slot.is_available && !slot.is_blocked\" class=\"badge bg-warning\">Voll</span>\n              </div>\n            </div>\n            \n            <div *ngIf=\"slot.bookings && slot.bookings.length > 0\" class=\"mt-2\">\n              <small class=\"text-muted\">Aktuelle Buchungen:</small>\n              <ul class=\"list-unstyled mb-0\">\n                <li *ngFor=\"let booking of slot.bookings\">\n                  <small>{{ booking.offer_label }} - {{ booking.teacher_name }} ({{ booking.student_count }} Schüler)</small>\n                </li>\n              </ul>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <div *ngIf=\"!loading && slots.length === 0\" class=\"alert alert-info\">\n        Keine Slots für dieses Datum verfügbar.\n      </div>\n    </div>\n  `,\n  styles: []\n})\nexport class SlotsComponent implements OnInit {\n  selectedDate: string = '';\n  slots: any[] = [];\n  loading: boolean = false;\n\n  constructor(\n    private apiService: ApiService,\n    private router: Router\n  ) { }\n\n  ngOnInit(): void {\n    this.selectedDate = new Date().toISOString().split('T')[0];\n    this.loadSlots();\n  }\n\n  loadSlots(): void {\n    if (!this.selectedDate) return;\n    \n    this.loading = true;\n    this.apiService.getSlots(this.selectedDate).subscribe({\n      next: (response) => {\n        this.slots = response.slots || [];\n        this.loading = false;\n      },\n      error: (error) => {\n        console.error('Error loading slots:', error);\n        this.loading = false;\n      }\n    });\n  }\n\n  bookSlot(slot: any): void {\n    this.router.navigate(['/book', this.selectedDate, slot.period]);\n  }\n\n  getSlotClass(slot: any): string {\n    if (slot.is_blocked) return 'slot-blocked';\n    if (slot.is_available) return 'slot-available';\n    return 'slot-full';\n  }\n}\n","size_bytes":3834},"backend/migrations/__init__.py":{"content":"","size_bytes":0},"backend/urls.py":{"content":"from django.urls import path\nfrom backend.views import slots, bookings, admin, csrf, auth\n\napp_name = 'sportoase'\n\nurlpatterns = [\n    path('csrf', csrf.get_csrf_token, name='csrf_token'),\n    path('login', auth.login_view, name='login'),\n    path('logout', auth.logout_view, name='logout'),\n    path('check-auth', auth.check_auth, name='check_auth'),\n    \n    path('slots', slots.get_available_slots, name='get_slots'),\n    path('slots/week', slots.get_week_overview, name='get_week'),\n    path('timeslots', slots.get_timeslots, name='get_timeslots'),\n    \n    path('book', bookings.create_booking, name='create_booking'),\n    path('my-bookings', bookings.get_my_bookings, name='my_bookings'),\n    path('bookings', bookings.get_all_bookings, name='all_bookings'),\n    path('bookings/<int:booking_id>', bookings.delete_booking, name='delete_booking'),\n    \n    path('block-slot', admin.block_slot, name='block_slot'),\n    path('unblock-slot', admin.unblock_slot, name='unblock_slot'),\n    path('blocked-slots', admin.get_blocked_slots, name='blocked_slots'),\n    \n    path('notifications', admin.get_notifications, name='notifications'),\n    path('notifications/<int:notification_id>/mark-read', admin.mark_notification_read, name='mark_notification_read'),\n]\n","size_bytes":1260},"frontend/src/app/services/api.service.ts":{"content":"import { Injectable } from '@angular/core';\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\nimport { Observable } from 'rxjs';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class ApiService {\n  private apiUrl = '/api/sportoase';\n  private csrfToken: string = '';\n\n  constructor(private http: HttpClient) {\n    this.initCsrfToken();\n  }\n\n  private initCsrfToken(): void {\n    this.http.get<any>(`${this.apiUrl}/csrf`, { withCredentials: true }).subscribe(\n      response => {\n        this.csrfToken = response.csrfToken;\n      },\n      error => console.error('Failed to get CSRF token:', error)\n    );\n  }\n\n  private getHeaders(): HttpHeaders {\n    let headers = new HttpHeaders({\n      'Content-Type': 'application/json'\n    });\n    \n    if (this.csrfToken) {\n      headers = headers.set('X-CSRFToken', this.csrfToken);\n    }\n    \n    return headers;\n  }\n\n  getSlots(date: string): Observable<any> {\n    return this.http.get(`${this.apiUrl}/slots?date=${date}`, { withCredentials: true });\n  }\n\n  getWeekOverview(startDate?: string): Observable<any> {\n    let url = `${this.apiUrl}/slots/week`;\n    if (startDate) {\n      url += `?start_date=${startDate}`;\n    }\n    return this.http.get(url, { withCredentials: true });\n  }\n\n  getTimeslots(): Observable<any> {\n    return this.http.get(`${this.apiUrl}/timeslots`, { withCredentials: true });\n  }\n\n  createBooking(bookingData: any): Observable<any> {\n    return this.http.post(`${this.apiUrl}/book`, bookingData, { \n      headers: this.getHeaders(),\n      withCredentials: true\n    });\n  }\n\n  getMyBookings(startDate?: string, endDate?: string): Observable<any> {\n    let url = `${this.apiUrl}/my-bookings`;\n    const params: string[] = [];\n    \n    if (startDate) params.push(`start_date=${startDate}`);\n    if (endDate) params.push(`end_date=${endDate}`);\n    \n    if (params.length > 0) {\n      url += '?' + params.join('&');\n    }\n    \n    return this.http.get(url, { withCredentials: true });\n  }\n\n  deleteBooking(bookingId: number): Observable<any> {\n    return this.http.delete(`${this.apiUrl}/bookings/${bookingId}`, {\n      headers: this.getHeaders(),\n      withCredentials: true\n    });\n  }\n\n  blockSlot(slotData: any): Observable<any> {\n    return this.http.post(`${this.apiUrl}/block-slot`, slotData, { \n      headers: this.getHeaders(),\n      withCredentials: true\n    });\n  }\n\n  unblockSlot(slotData: any): Observable<any> {\n    return this.http.post(`${this.apiUrl}/unblock-slot`, slotData, { \n      headers: this.getHeaders(),\n      withCredentials: true\n    });\n  }\n\n  getBlockedSlots(): Observable<any> {\n    return this.http.get(`${this.apiUrl}/blocked-slots`, { withCredentials: true });\n  }\n\n  getAllBookings(date?: string): Observable<any> {\n    let url = `${this.apiUrl}/bookings`;\n    if (date) {\n      url += `?date=${date}`;\n    }\n    return this.http.get(url, { withCredentials: true });\n  }\n\n  getNotifications(unreadOnly: boolean = false): Observable<any> {\n    let url = `${this.apiUrl}/notifications`;\n    if (unreadOnly) {\n      url += '?unread_only=true';\n    }\n    return this.http.get(url, { withCredentials: true });\n  }\n\n  markNotificationRead(notificationId: number): Observable<any> {\n    return this.http.post(`${this.apiUrl}/notifications/${notificationId}/mark-read`, {}, { \n      headers: this.getHeaders(),\n      withCredentials: true\n    });\n  }\n}\n","size_bytes":3359},"frontend/src/main.ts":{"content":"import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';\nimport { AppModule } from './app/app.module';\n\nplatformBrowserDynamic().bootstrapModule(AppModule)\n  .catch(err => console.error(err));\n","size_bytes":212},"frontend/src/app/components/booking-form/booking-form.component.ts":{"content":"import { Component, OnInit } from '@angular/core';\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { FormBuilder, FormGroup, Validators, FormArray } from '@angular/forms';\nimport { ApiService } from '../../services/api.service';\n\n@Component({\n  selector: 'app-booking-form',\n  template: `\n    <div class=\"card\">\n      <h2>Slot buchen</h2>\n      <p>Datum: {{ date }} - {{ period }}. Stunde</p>\n      \n      <form [formGroup]=\"bookingForm\" (ngSubmit)=\"submitBooking()\">\n        <div class=\"mb-3\">\n          <label class=\"form-label\">Angebotsart</label>\n          <select class=\"form-select\" formControlName=\"offer_type\">\n            <option value=\"sport\">Sport</option>\n            <option value=\"games\">Spiele</option>\n            <option value=\"outdoor\">Outdoor</option>\n            <option value=\"other\">Sonstiges</option>\n          </select>\n        </div>\n        \n        <div class=\"mb-3\">\n          <label class=\"form-label\">Angebotsbezeichnung</label>\n          <input type=\"text\" class=\"form-control\" formControlName=\"offer_label\" \n                 placeholder=\"z.B. Basketball, Fußball, etc.\">\n        </div>\n        \n        <div class=\"mb-3\">\n          <label class=\"form-label\">Lehrkraft Name</label>\n          <input type=\"text\" class=\"form-control\" formControlName=\"teacher_name\">\n        </div>\n        \n        <div class=\"mb-3\">\n          <label class=\"form-label\">Klasse</label>\n          <input type=\"text\" class=\"form-control\" formControlName=\"teacher_class\"\n                 placeholder=\"z.B. 5a, 6b, etc.\">\n        </div>\n        \n        <div class=\"mb-3\">\n          <label class=\"form-label\">Schüler</label>\n          <div formArrayName=\"students\">\n            <div *ngFor=\"let student of students.controls; let i = index\" [formGroupName]=\"i\" class=\"mb-2\">\n              <div class=\"row\">\n                <div class=\"col-md-5\">\n                  <input type=\"text\" class=\"form-control\" formControlName=\"name\" placeholder=\"Name\">\n                </div>\n                <div class=\"col-md-5\">\n                  <input type=\"text\" class=\"form-control\" formControlName=\"klasse\" placeholder=\"Klasse\">\n                </div>\n                <div class=\"col-md-2\">\n                  <button type=\"button\" class=\"btn btn-danger\" (click)=\"removeStudent(i)\">\n                    Entfernen\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n          <button type=\"button\" class=\"btn btn-secondary mt-2\" (click)=\"addStudent()\">\n            + Schüler hinzufügen\n          </button>\n        </div>\n        \n        <div class=\"d-flex gap-2\">\n          <button type=\"submit\" class=\"btn btn-primary\" [disabled]=\"!bookingForm.valid || submitting\">\n            {{ submitting ? 'Wird gespeichert...' : 'Buchen' }}\n          </button>\n          <button type=\"button\" class=\"btn btn-secondary\" (click)=\"cancel()\">\n            Abbrechen\n          </button>\n        </div>\n        \n        <div *ngIf=\"errorMessage\" class=\"alert alert-danger mt-3\">\n          {{ errorMessage }}\n        </div>\n        \n        <div *ngIf=\"successMessage\" class=\"alert alert-success mt-3\">\n          {{ successMessage }}\n        </div>\n      </form>\n    </div>\n  `,\n  styles: []\n})\nexport class BookingFormComponent implements OnInit {\n  date: string = '';\n  period: number = 0;\n  weekday: string = '';\n  bookingForm: FormGroup;\n  submitting: boolean = false;\n  errorMessage: string = '';\n  successMessage: string = '';\n\n  constructor(\n    private route: ActivatedRoute,\n    private router: Router,\n    private fb: FormBuilder,\n    private apiService: ApiService\n  ) {\n    this.bookingForm = this.fb.group({\n      offer_type: ['sport', Validators.required],\n      offer_label: ['', Validators.required],\n      teacher_name: ['', Validators.required],\n      teacher_class: [''],\n      students: this.fb.array([])\n    });\n  }\n\n  ngOnInit(): void {\n    this.date = this.route.snapshot.paramMap.get('date') || '';\n    this.period = parseInt(this.route.snapshot.paramMap.get('period') || '0');\n    this.weekday = this.getWeekday(this.date);\n    \n    this.addStudent();\n  }\n\n  get students(): FormArray {\n    return this.bookingForm.get('students') as FormArray;\n  }\n\n  addStudent(): void {\n    this.students.push(this.fb.group({\n      name: ['', Validators.required],\n      klasse: ['', Validators.required]\n    }));\n  }\n\n  removeStudent(index: number): void {\n    this.students.removeAt(index);\n  }\n\n  submitBooking(): void {\n    if (!this.bookingForm.valid) return;\n    \n    this.submitting = true;\n    this.errorMessage = '';\n    this.successMessage = '';\n    \n    const bookingData = {\n      date: this.date,\n      weekday: this.weekday,\n      period: this.period,\n      ...this.bookingForm.value\n    };\n    \n    this.apiService.createBooking(bookingData).subscribe({\n      next: (response) => {\n        this.submitting = false;\n        this.successMessage = 'Buchung erfolgreich erstellt!';\n        setTimeout(() => {\n          this.router.navigate(['/my-bookings']);\n        }, 2000);\n      },\n      error: (error) => {\n        this.submitting = false;\n        this.errorMessage = error.error?.error || 'Fehler beim Erstellen der Buchung';\n      }\n    });\n  }\n\n  cancel(): void {\n    this.router.navigate(['/slots']);\n  }\n\n  private getWeekday(dateStr: string): string {\n    const date = new Date(dateStr);\n    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n    return days[date.getDay()];\n  }\n}\n","size_bytes":5476},"backend/migrations/0001_initial.py":{"content":"# Generated by Django 4.2.7 on 2025-11-20 18:17\n\nfrom django.conf import settings\nfrom django.db import migrations, models\nimport django.db.models.deletion\nimport django.utils.timezone\n\n\nclass Migration(migrations.Migration):\n\n    initial = True\n\n    dependencies = [\n        migrations.swappable_dependency(settings.AUTH_USER_MODEL),\n    ]\n\n    operations = [\n        migrations.CreateModel(\n            name='Booking',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('date', models.DateField(db_index=True)),\n                ('weekday', models.CharField(max_length=3)),\n                ('period', models.IntegerField()),\n                ('teacher_name', models.CharField(max_length=100)),\n                ('teacher_class', models.CharField(blank=True, max_length=50)),\n                ('students_json', models.TextField()),\n                ('offer_type', models.CharField(choices=[('sport', 'Sport'), ('games', 'Spiele'), ('outdoor', 'Outdoor'), ('other', 'Sonstiges')], max_length=10)),\n                ('offer_label', models.CharField(max_length=100)),\n                ('calendar_event_id', models.CharField(blank=True, max_length=200, null=True)),\n                ('created_at', models.DateTimeField(db_index=True, default=django.utils.timezone.now)),\n                ('updated_at', models.DateTimeField(auto_now=True)),\n                ('teacher', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='sportoase_bookings', to=settings.AUTH_USER_MODEL)),\n            ],\n            options={\n                'db_table': 'sportoase_bookings',\n                'ordering': ['-date', 'period'],\n            },\n        ),\n        migrations.CreateModel(\n            name='TimeSlot',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('weekday', models.CharField(choices=[('Mon', 'Montag'), ('Tue', 'Dienstag'), ('Wed', 'Mittwoch'), ('Thu', 'Donnerstag'), ('Fri', 'Freitag')], max_length=3)),\n                ('period', models.IntegerField()),\n                ('label', models.CharField(max_length=200)),\n                ('start_time', models.TimeField()),\n                ('end_time', models.TimeField()),\n                ('max_students', models.IntegerField(default=200)),\n            ],\n            options={\n                'db_table': 'sportoase_timeslots',\n                'ordering': ['weekday', 'period'],\n                'unique_together': {('weekday', 'period')},\n            },\n        ),\n        migrations.CreateModel(\n            name='Notification',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('notification_type', models.CharField(choices=[('new_booking', 'Neue Buchung'), ('booking_updated', 'Buchung aktualisiert'), ('booking_deleted', 'Buchung gelöscht'), ('slot_blocked', 'Slot blockiert')], max_length=50)),\n                ('message', models.CharField(max_length=500)),\n                ('is_read', models.BooleanField(db_index=True, default=False)),\n                ('read_at', models.DateTimeField(blank=True, null=True)),\n                ('created_at', models.DateTimeField(db_index=True, default=django.utils.timezone.now)),\n                ('metadata_json', models.TextField(blank=True)),\n                ('booking', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='notifications', to='backend.booking')),\n            ],\n            options={\n                'db_table': 'sportoase_notifications',\n                'ordering': ['-created_at'],\n            },\n        ),\n        migrations.CreateModel(\n            name='BlockedSlot',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('date', models.DateField(db_index=True)),\n                ('weekday', models.CharField(max_length=3)),\n                ('period', models.IntegerField()),\n                ('reason', models.CharField(default='Beratung', max_length=200)),\n                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),\n                ('blocked_by', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='sportoase_blocked_slots', to=settings.AUTH_USER_MODEL)),\n            ],\n            options={\n                'db_table': 'sportoase_blocked_slots',\n                'ordering': ['-date', 'period'],\n            },\n        ),\n        migrations.AddIndex(\n            model_name='booking',\n            index=models.Index(fields=['date', 'period'], name='sportoase_b_date_feaf3a_idx'),\n        ),\n        migrations.AddIndex(\n            model_name='booking',\n            index=models.Index(fields=['teacher'], name='sportoase_b_teacher_878f77_idx'),\n        ),\n        migrations.AddIndex(\n            model_name='blockedslot',\n            index=models.Index(fields=['date', 'period'], name='sportoase_b_date_7af2f2_idx'),\n        ),\n        migrations.AlterUniqueTogether(\n            name='blockedslot',\n            unique_together={('date', 'period')},\n        ),\n    ]\n","size_bytes":5317},"backend/services/booking_service.py":{"content":"from datetime import datetime, timedelta\nfrom django.db.models import Q, Count, Sum\nfrom django.db import transaction\nfrom backend.models import Booking, TimeSlot, BlockedSlot, Notification\nimport json\n\n\nclass BookingService:\n    \"\"\"Service-Klasse für Buchungslogik\"\"\"\n    \n    @staticmethod\n    def get_available_slots(date, user=None):\n        \"\"\"\n        Gibt alle verfügbaren Slots für ein bestimmtes Datum zurück\n        \n        Args:\n            date: datetime.date object\n            user: Optional - Django User object für Filterung\n        \n        Returns:\n            List von Dictionaries mit Slot-Informationen\n        \"\"\"\n        weekday_map = {\n            0: 'Mon', 1: 'Tue', 2: 'Wed', 3: 'Thu', 4: 'Fri',\n            5: 'Sat', 6: 'Sun'\n        }\n        weekday = weekday_map.get(date.weekday(), 'Mon')\n        \n        timeslots = TimeSlot.objects.filter(weekday=weekday).order_by('period')\n        \n        bookings = Booking.objects.filter(date=date)\n        blocked_slots = BlockedSlot.objects.filter(date=date)\n        \n        booking_dict = {}\n        for booking in bookings:\n            period = booking.period\n            if period not in booking_dict:\n                booking_dict[period] = []\n            booking_dict[period].append(booking)\n        \n        blocked_dict = {bs.period: bs for bs in blocked_slots}\n        \n        result = []\n        for slot in timeslots:\n            period_bookings = booking_dict.get(slot.period, [])\n            student_count = sum(b.student_count for b in period_bookings)\n            \n            is_blocked = slot.period in blocked_dict\n            is_available = not is_blocked and student_count < slot.max_students\n            \n            slot_info = {\n                'period': slot.period,\n                'weekday': slot.weekday,\n                'label': slot.label,\n                'start_time': slot.start_time.strftime('%H:%M'),\n                'end_time': slot.end_time.strftime('%H:%M'),\n                'max_students': slot.max_students,\n                'current_students': student_count,\n                'available_spots': max(0, slot.max_students - student_count),\n                'is_available': is_available,\n                'is_blocked': is_blocked,\n                'blocked_reason': blocked_dict[slot.period].reason if is_blocked else None,\n                'bookings': [b.to_dict() for b in period_bookings],\n            }\n            \n            result.append(slot_info)\n        \n        return result\n    \n    @staticmethod\n    def check_student_double_booking(student_name, student_class, date, period, exclude_booking_id=None):\n        \"\"\"\n        Prüft, ob ein Schüler bereits für dieses Datum und diese Stunde gebucht ist\n        \n        Returns:\n            Dict mit 'is_booked' (bool) und 'booking_info' (str) oder None\n        \"\"\"\n        bookings = Booking.objects.filter(date=date, period=period)\n        \n        if exclude_booking_id:\n            bookings = bookings.exclude(id=exclude_booking_id)\n        \n        for booking in bookings:\n            students = booking.students\n            for student in students:\n                if (student.get('name', '').strip().lower() == student_name.strip().lower() and \n                    student.get('klasse', '').strip().lower() == student_class.strip().lower()):\n                    return {\n                        'is_booked': True,\n                        'booking_info': f\"{student_name} ({student_class}) ist bereits in '{booking.offer_label}' bei {booking.teacher_name} gebucht.\"\n                    }\n        \n        return {'is_booked': False, 'booking_info': None}\n    \n    @staticmethod\n    @transaction.atomic\n    def create_booking(date, weekday, period, teacher, students, offer_type, offer_label, \n                      teacher_name=None, teacher_class=None):\n        \"\"\"\n        Erstellt eine neue Buchung\n        \n        Args:\n            date: datetime.date object\n            weekday: String ('Mon', 'Tue', etc.)\n            period: Integer (1-6)\n            teacher: Django User object\n            students: List of dicts with student info\n            offer_type: String\n            offer_label: String\n            teacher_name: Optional string\n            teacher_class: Optional string\n        \n        Returns:\n            Booking object oder None bei Fehler\n        \"\"\"\n        if BlockedSlot.objects.filter(date=date, period=period).exists():\n            raise ValueError(\"Dieser Slot ist blockiert\")\n        \n        for student in students:\n            check = BookingService.check_student_double_booking(\n                student['name'], student['klasse'], date, period\n            )\n            if check['is_booked']:\n                raise ValueError(check['booking_info'])\n        \n        booking = Booking.objects.create(\n            date=date,\n            weekday=weekday,\n            period=period,\n            teacher=teacher,\n            teacher_name=teacher_name or teacher.get_full_name() or teacher.username,\n            teacher_class=teacher_class or '',\n            students=students,\n            offer_type=offer_type,\n            offer_label=offer_label,\n        )\n        \n        Notification.objects.create(\n            booking=booking,\n            notification_type='new_booking',\n            message=f\"Neue Buchung: {offer_label} von {teacher_name} am {date.strftime('%d.%m.%Y')} - {period}. Stunde\",\n        )\n        \n        return booking\n    \n    @staticmethod\n    def get_user_bookings(user, start_date=None, end_date=None):\n        \"\"\"\n        Gibt alle Buchungen eines Benutzers zurück\n        \n        Args:\n            user: Django User object\n            start_date: Optional datetime.date\n            end_date: Optional datetime.date\n        \n        Returns:\n            QuerySet von Booking objects\n        \"\"\"\n        bookings = Booking.objects.filter(teacher=user)\n        \n        if start_date:\n            bookings = bookings.filter(date__gte=start_date)\n        if end_date:\n            bookings = bookings.filter(date__lte=end_date)\n        \n        return bookings.order_by('-date', 'period')\n    \n    @staticmethod\n    @transaction.atomic\n    def block_slot(date, weekday, period, admin_user, reason='Beratung'):\n        \"\"\"\n        Blockiert einen Slot (nur für Admins)\n        \n        Args:\n            date: datetime.date object\n            weekday: String\n            period: Integer\n            admin_user: Django User object (Admin)\n            reason: String - Grund der Blockierung\n        \n        Returns:\n            BlockedSlot object\n        \"\"\"\n        if not admin_user.has_perm('sportoase.admin'):\n            raise PermissionError(\"Nur Admins dürfen Slots blockieren\")\n        \n        if BlockedSlot.objects.filter(date=date, period=period).exists():\n            raise ValueError(\"Slot ist bereits blockiert\")\n        \n        blocked = BlockedSlot.objects.create(\n            date=date,\n            weekday=weekday,\n            period=period,\n            reason=reason,\n            blocked_by=admin_user,\n        )\n        \n        Notification.objects.create(\n            notification_type='slot_blocked',\n            message=f\"Slot blockiert: {date.strftime('%d.%m.%Y')} - {period}. Stunde ({reason})\",\n        )\n        \n        return blocked\n    \n    @staticmethod\n    @transaction.atomic\n    def unblock_slot(date, period, admin_user):\n        \"\"\"\n        Gibt einen blockierten Slot wieder frei\n        \n        Args:\n            date: datetime.date object\n            period: Integer\n            admin_user: Django User object (Admin)\n        \n        Returns:\n            True bei Erfolg\n        \"\"\"\n        if not admin_user.has_perm('sportoase.admin'):\n            raise PermissionError(\"Nur Admins dürfen Slots entsperren\")\n        \n        blocked = BlockedSlot.objects.filter(date=date, period=period).first()\n        if not blocked:\n            raise ValueError(\"Slot ist nicht blockiert\")\n        \n        blocked.delete()\n        return True\n    \n    @staticmethod\n    @transaction.atomic\n    def delete_booking(booking_id, user):\n        \"\"\"\n        Löscht eine Buchung\n        \n        Args:\n            booking_id: Integer\n            user: Django User object\n        \n        Returns:\n            True bei Erfolg\n        \"\"\"\n        booking = Booking.objects.filter(id=booking_id).first()\n        if not booking:\n            raise ValueError(\"Buchung nicht gefunden\")\n        \n        if booking.teacher != user and not user.has_perm('sportoase.admin'):\n            raise PermissionError(\"Keine Berechtigung zum Löschen dieser Buchung\")\n        \n        Notification.objects.create(\n            notification_type='booking_deleted',\n            message=f\"Buchung gelöscht: {booking.offer_label} von {booking.teacher_name} am {booking.date.strftime('%d.%m.%Y')}\",\n        )\n        \n        booking.delete()\n        return True\n    \n    @staticmethod\n    def get_unread_notifications(limit=50):\n        \"\"\"Gibt ungelesene Benachrichtigungen zurück\"\"\"\n        return Notification.objects.filter(is_read=False).order_by('-created_at')[:limit]\n    \n    @staticmethod\n    def mark_notification_read(notification_id):\n        \"\"\"Markiert eine Benachrichtigung als gelesen\"\"\"\n        notification = Notification.objects.filter(id=notification_id).first()\n        if notification:\n            notification.is_read = True\n            notification.read_at = datetime.now()\n            notification.save()\n            return True\n        return False\n","size_bytes":9520},"backend/views/csrf.py":{"content":"from django.http import JsonResponse\nfrom django.middleware.csrf import get_token\nfrom django.views.decorators.http import require_http_methods\n\n\n@require_http_methods([\"GET\"])\ndef get_csrf_token(request):\n    \"\"\"GET /api/sportoase/csrf - Returns CSRF token for the frontend\"\"\"\n    return JsonResponse({\n        'csrfToken': get_token(request)\n    })\n","size_bytes":351},"frontend/src/app/app.module.ts":{"content":"import { NgModule } from '@angular/core';\nimport { BrowserModule } from '@angular/platform-browser';\nimport { HttpClientModule } from '@angular/common/http';\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\nimport { RouterModule, Routes } from '@angular/router';\n\nimport { AppComponent } from './app.component';\nimport { DashboardComponent } from './components/dashboard/dashboard.component';\nimport { SlotsComponent } from './components/slots/slots.component';\nimport { BookingFormComponent } from './components/booking-form/booking-form.component';\nimport { MyBookingsComponent } from './components/my-bookings/my-bookings.component';\nimport { AdminPanelComponent } from './components/admin-panel/admin-panel.component';\nimport { WeekOverviewComponent } from './components/week-overview/week-overview.component';\n\nimport { ApiService } from './services/api.service';\n\nconst routes: Routes = [\n  { path: '', redirectTo: '/dashboard', pathMatch: 'full' },\n  { path: 'dashboard', component: DashboardComponent },\n  { path: 'week-overview', component: WeekOverviewComponent },\n  { path: 'slots', component: SlotsComponent },\n  { path: 'book/:date/:period', component: BookingFormComponent },\n  { path: 'my-bookings', component: MyBookingsComponent },\n  { path: 'admin', component: AdminPanelComponent },\n];\n\n@NgModule({\n  declarations: [\n    AppComponent,\n    DashboardComponent,\n    WeekOverviewComponent,\n    SlotsComponent,\n    BookingFormComponent,\n    MyBookingsComponent,\n    AdminPanelComponent,\n  ],\n  imports: [\n    BrowserModule,\n    HttpClientModule,\n    FormsModule,\n    ReactiveFormsModule,\n    RouterModule.forRoot(routes),\n  ],\n  providers: [ApiService],\n  bootstrap: [AppComponent]\n})\nexport class AppModule { }\n","size_bytes":1744},"backend/views/admin.py":{"content":"from django.http import JsonResponse, HttpResponseForbidden\nfrom django.views.decorators.http import require_http_methods\nfrom datetime import datetime\nfrom backend.services.booking_service import BookingService\nfrom backend.models import BlockedSlot, Notification\nimport json\n\n\n@require_http_methods([\"POST\"])\ndef block_slot(request):\n    \"\"\"POST /api/sportoase/block-slot - Blockiert einen Slot (Admin only)\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.admin\"):\n        return HttpResponseForbidden(\"Nur für Admins\")\n    \n    try:\n        data = json.loads(request.body)\n    except json.JSONDecodeError:\n        return JsonResponse({'success': False, 'error': 'Ungültige JSON-Daten'}, status=400)\n    \n    required_fields = ['date', 'weekday', 'period']\n    for field in required_fields:\n        if field not in data:\n            return JsonResponse({'success': False, 'error': f'Feld \"{field}\" fehlt'}, status=400)\n    \n    try:\n        date = datetime.strptime(data['date'], '%Y-%m-%d').date()\n    except ValueError:\n        return JsonResponse({'success': False, 'error': 'Ungültiges Datumsformat'}, status=400)\n    \n    try:\n        blocked = BookingService.block_slot(\n            date=date,\n            weekday=data['weekday'],\n            period=data['period'],\n            admin_user=request.user,\n            reason=data.get('reason', 'Beratung')\n        )\n        \n        return JsonResponse({\n            'success': True,\n            'message': 'Slot erfolgreich blockiert',\n            'blocked_slot': blocked.to_dict()\n        })\n    \n    except ValueError as e:\n        return JsonResponse({'success': False, 'error': str(e)}, status=400)\n    except PermissionError as e:\n        return JsonResponse({'success': False, 'error': str(e)}, status=403)\n    except Exception as e:\n        return JsonResponse({'success': False, 'error': f'Fehler: {str(e)}'}, status=500)\n\n\n@require_http_methods([\"POST\"])\ndef unblock_slot(request):\n    \"\"\"POST /api/sportoase/unblock-slot - Gibt einen Slot frei (Admin only)\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.admin\"):\n        return HttpResponseForbidden(\"Nur für Admins\")\n    \n    try:\n        data = json.loads(request.body)\n    except json.JSONDecodeError:\n        return JsonResponse({'success': False, 'error': 'Ungültige JSON-Daten'}, status=400)\n    \n    try:\n        date = datetime.strptime(data['date'], '%Y-%m-%d').date()\n    except ValueError:\n        return JsonResponse({'success': False, 'error': 'Ungültiges Datumsformat'}, status=400)\n    \n    try:\n        BookingService.unblock_slot(date, data['period'], request.user)\n        return JsonResponse({\n            'success': True,\n            'message': 'Slot erfolgreich freigegeben'\n        })\n    \n    except ValueError as e:\n        return JsonResponse({'success': False, 'error': str(e)}, status=404)\n    except PermissionError as e:\n        return JsonResponse({'success': False, 'error': str(e)}, status=403)\n    except Exception as e:\n        return JsonResponse({'success': False, 'error': f'Fehler: {str(e)}'}, status=500)\n\n\n@require_http_methods([\"GET\"])\ndef get_blocked_slots(request):\n    \"\"\"GET /api/sportoase/blocked-slots - Gibt alle blockierten Slots zurück\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.admin\"):\n        return HttpResponseForbidden(\"Nur für Admins\")\n    \n    blocked_slots = BlockedSlot.objects.all().order_by('-date', 'period')[:100]\n    \n    return JsonResponse({\n        'success': True,\n        'blocked_slots': [bs.to_dict() for bs in blocked_slots]\n    })\n\n\n@require_http_methods([\"GET\"])\ndef get_notifications(request):\n    \"\"\"GET /api/sportoase/notifications - Gibt Benachrichtigungen zurück\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.admin\"):\n        return HttpResponseForbidden(\"Nur für Admins\")\n    \n    unread_only = request.GET.get('unread_only') == 'true'\n    \n    if unread_only:\n        notifications = BookingService.get_unread_notifications()\n    else:\n        notifications = Notification.objects.all().order_by('-created_at')[:50]\n    \n    return JsonResponse({\n        'success': True,\n        'notifications': [n.to_dict() for n in notifications]\n    })\n\n\n@require_http_methods([\"POST\"])\ndef mark_notification_read(request, notification_id):\n    \"\"\"POST /api/sportoase/notifications/<id>/mark-read - Markiert Benachrichtigung als gelesen\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.admin\"):\n        return HttpResponseForbidden(\"Nur für Admins\")\n    \n    success = BookingService.mark_notification_read(notification_id)\n    \n    if success:\n        return JsonResponse({\n            'success': True,\n            'message': 'Benachrichtigung als gelesen markiert'\n        })\n    else:\n        return JsonResponse({\n            'success': False,\n            'error': 'Benachrichtigung nicht gefunden'\n        }, status=404)\n","size_bytes":5415},"frontend/src/app/components/my-bookings/my-bookings.component.ts":{"content":"import { Component, OnInit } from '@angular/core';\nimport { ApiService } from '../../services/api.service';\n\n@Component({\n  selector: 'app-my-bookings',\n  template: `\n    <div class=\"card\">\n      <h2>Meine Buchungen</h2>\n      \n      <div *ngIf=\"loading\" class=\"loading-container\">\n        <div class=\"spinner-border text-primary\" role=\"status\">\n          <span class=\"visually-hidden\">Laden...</span>\n        </div>\n      </div>\n      \n      <div *ngIf=\"!loading && bookings.length > 0\">\n        <table class=\"table table-striped\">\n          <thead>\n            <tr>\n              <th>Datum</th>\n              <th>Stunde</th>\n              <th>Angebot</th>\n              <th>Schüler</th>\n              <th>Aktionen</th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr *ngFor=\"let booking of bookings\">\n              <td>{{ booking.date }}</td>\n              <td>{{ booking.period }}. Stunde</td>\n              <td>{{ booking.offer_label }}</td>\n              <td>{{ booking.student_count }} Schüler</td>\n              <td>\n                <button class=\"btn btn-sm btn-danger\" (click)=\"deleteBooking(booking.id)\">\n                  Löschen\n                </button>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n      \n      <div *ngIf=\"!loading && bookings.length === 0\" class=\"alert alert-info\">\n        Sie haben noch keine Buchungen.\n      </div>\n      \n      <div *ngIf=\"successMessage\" class=\"alert alert-success mt-3\">\n        {{ successMessage }}\n      </div>\n      \n      <div *ngIf=\"errorMessage\" class=\"alert alert-danger mt-3\">\n        {{ errorMessage }}\n      </div>\n    </div>\n  `,\n  styles: []\n})\nexport class MyBookingsComponent implements OnInit {\n  bookings: any[] = [];\n  loading: boolean = false;\n  successMessage: string = '';\n  errorMessage: string = '';\n\n  constructor(private apiService: ApiService) { }\n\n  ngOnInit(): void {\n    this.loadBookings();\n  }\n\n  loadBookings(): void {\n    this.loading = true;\n    this.apiService.getMyBookings().subscribe({\n      next: (response) => {\n        this.bookings = response.bookings || [];\n        this.loading = false;\n      },\n      error: (error) => {\n        console.error('Error loading bookings:', error);\n        this.loading = false;\n        this.errorMessage = 'Fehler beim Laden der Buchungen';\n      }\n    });\n  }\n\n  deleteBooking(bookingId: number): void {\n    if (!confirm('Möchten Sie diese Buchung wirklich löschen?')) {\n      return;\n    }\n    \n    this.apiService.deleteBooking(bookingId).subscribe({\n      next: (response) => {\n        this.successMessage = 'Buchung erfolgreich gelöscht';\n        this.loadBookings();\n        setTimeout(() => this.successMessage = '', 3000);\n      },\n      error: (error) => {\n        this.errorMessage = error.error?.error || 'Fehler beim Löschen der Buchung';\n        setTimeout(() => this.errorMessage = '', 3000);\n      }\n    });\n  }\n}\n","size_bytes":2930},"frontend/src/app/app.component.ts":{"content":"import { Component } from '@angular/core';\n\n@Component({\n  selector: 'app-root',\n  template: `\n    <nav class=\"navbar navbar-expand-lg navbar-dark\">\n      <div class=\"container-fluid\">\n        <a class=\"navbar-brand\" href=\"#\">SportOase</a>\n        <button class=\"navbar-toggler\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#navbarNav\">\n          <span class=\"navbar-toggler-icon\"></span>\n        </button>\n        <div class=\"collapse navbar-collapse\" id=\"navbarNav\">\n          <ul class=\"navbar-nav\">\n            <li class=\"nav-item\">\n              <a class=\"nav-link\" routerLink=\"/dashboard\" routerLinkActive=\"active\">Dashboard</a>\n            </li>\n            <li class=\"nav-item\">\n              <a class=\"nav-link\" routerLink=\"/week-overview\" routerLinkActive=\"active\">Wochenübersicht</a>\n            </li>\n            <li class=\"nav-item\">\n              <a class=\"nav-link\" routerLink=\"/slots\" routerLinkActive=\"active\">Slots anzeigen</a>\n            </li>\n            <li class=\"nav-item\">\n              <a class=\"nav-link\" routerLink=\"/my-bookings\" routerLinkActive=\"active\">Meine Buchungen</a>\n            </li>\n            <li class=\"nav-item\">\n              <a class=\"nav-link\" routerLink=\"/admin\" routerLinkActive=\"active\">Admin</a>\n            </li>\n          </ul>\n        </div>\n      </div>\n    </nav>\n    <div class=\"container mt-4\">\n      <router-outlet></router-outlet>\n    </div>\n  `,\n  styles: []\n})\nexport class AppComponent {\n  title = 'SportOase Buchungssystem';\n}\n","size_bytes":1502},"frontend/src/app/components/dashboard/dashboard.component.ts":{"content":"import { Component, OnInit } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { ApiService } from '../../services/api.service';\n\n@Component({\n  selector: 'app-dashboard',\n  template: `\n    <div class=\"container-fluid\">\n      <div class=\"dashboard-header mb-4\">\n        <h2>SportOase - Wochenübersicht</h2>\n        <div class=\"d-flex justify-content-between align-items-center mt-3\">\n          <div class=\"week-controls\">\n            <button class=\"btn btn-secondary me-2\" (click)=\"previousWeek()\">\n              ← Vorherige Woche\n            </button>\n            <button class=\"btn btn-secondary me-2\" (click)=\"currentWeek()\">\n              Aktuelle Woche\n            </button>\n            <button class=\"btn btn-secondary\" (click)=\"nextWeek()\">\n              Nächste Woche →\n            </button>\n            <span class=\"ms-3 text-muted\">\n              Woche ab {{ formatDate(startDate) }}\n            </span>\n          </div>\n          <div class=\"quick-actions\">\n            <a routerLink=\"/my-bookings\" class=\"btn btn-primary me-2\">Meine Buchungen</a>\n            <a routerLink=\"/admin\" class=\"btn btn-warning\">Admin</a>\n          </div>\n        </div>\n      </div>\n      \n      <div *ngIf=\"loading\" class=\"loading-container\">\n        <div class=\"spinner-border text-primary\" role=\"status\">\n          <span class=\"visually-hidden\">Laden...</span>\n        </div>\n      </div>\n      \n      <div *ngIf=\"!loading && weekData.length > 0\" class=\"week-grid\">\n        <div *ngFor=\"let day of weekData\" class=\"day-column\">\n          <div class=\"day-header\">\n            <h5>{{ getWeekdayName(day.weekday) }}</h5>\n            <small>{{ formatDateShort(day.date) }}</small>\n          </div>\n          \n          <div class=\"slots-container\">\n            <div *ngFor=\"let slot of day.slots\" \n                 class=\"slot-card mb-2\" \n                 [ngClass]=\"getSlotClass(slot)\"\n                 (click)=\"selectSlot(day.date, slot)\">\n              <div class=\"slot-header\">\n                <strong>{{ slot.period }}. Stunde</strong>\n                <small>{{ slot.start_time }} - {{ slot.end_time }}</small>\n              </div>\n              <div class=\"slot-label\">\n                <strong>{{ slot.label }}</strong>\n              </div>\n              <div class=\"slot-info\">\n                <div *ngIf=\"!slot.is_blocked\">\n                  <small>{{ slot.current_students }}/{{ slot.max_students }} Schüler</small>\n                  <div class=\"progress mt-1\" style=\"height: 4px;\">\n                    <div class=\"progress-bar\" \n                         [ngClass]=\"getProgressClass(slot)\"\n                         [style.width.%]=\"getProgressPercent(slot)\">\n                    </div>\n                  </div>\n                </div>\n                <div *ngIf=\"slot.is_blocked\" class=\"text-danger\">\n                  <small><strong>Blockiert</strong></small>\n                </div>\n              </div>\n              <div *ngIf=\"slot.bookings && slot.bookings.length > 0\" class=\"mt-1\">\n                <small class=\"text-muted\">\n                  {{ slot.bookings[0].offer_label }}\n                  <span *ngIf=\"slot.bookings.length > 1\">\n                    +{{ slot.bookings.length - 1 }}\n                  </span>\n                </small>\n              </div>\n            </div>\n            \n            <div *ngIf=\"day.slots.length === 0\" class=\"alert alert-info\">\n              Keine Slots\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <div *ngIf=\"!loading && weekData.length === 0\" class=\"alert alert-warning\">\n        Keine Daten für diese Woche verfügbar\n      </div>\n      \n      <div *ngIf=\"errorMessage\" class=\"alert alert-danger mt-3\">\n        {{ errorMessage }}\n      </div>\n    </div>\n  `,\n  styles: [`\n    .dashboard-header {\n      background: linear-gradient(135deg, #2c5aa0 0%, #5a8ed9 100%);\n      color: white;\n      padding: 20px;\n      border-radius: 8px;\n      margin-bottom: 20px;\n    }\n    \n    .dashboard-header h2 {\n      margin: 0;\n      font-size: 1.8rem;\n    }\n    \n    .week-grid {\n      display: grid;\n      grid-template-columns: repeat(5, 1fr);\n      gap: 15px;\n    }\n    \n    @media (max-width: 1200px) {\n      .week-grid {\n        grid-template-columns: repeat(3, 1fr);\n      }\n    }\n    \n    @media (max-width: 768px) {\n      .week-grid {\n        grid-template-columns: repeat(2, 1fr);\n      }\n      .quick-actions {\n        margin-top: 10px;\n      }\n    }\n    \n    @media (max-width: 480px) {\n      .week-grid {\n        grid-template-columns: 1fr;\n      }\n    }\n    \n    .day-column {\n      border: 1px solid #dee2e6;\n      border-radius: 8px;\n      overflow: hidden;\n      background: white;\n    }\n    \n    .day-header {\n      background: linear-gradient(135deg, #2c5aa0 0%, #5a8ed9 100%);\n      color: white;\n      padding: 12px;\n      text-align: center;\n    }\n    \n    .day-header h5 {\n      margin: 0;\n      font-size: 1rem;\n    }\n    \n    .day-header small {\n      color: rgba(255, 255, 255, 0.9);\n    }\n    \n    .slots-container {\n      padding: 10px;\n      max-height: 600px;\n      overflow-y: auto;\n    }\n    \n    .slot-card {\n      padding: 10px;\n      border-radius: 6px;\n      cursor: pointer;\n      transition: transform 0.2s, box-shadow 0.2s;\n      border: 1px solid #dee2e6;\n    }\n    \n    .slot-card:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);\n    }\n    \n    .slot-card.slot-available {\n      background-color: #d4edda;\n      border-left: 4px solid #28a745;\n    }\n    \n    .slot-card.slot-blocked {\n      background-color: #f8d7da;\n      border-left: 4px solid #dc3545;\n      cursor: not-allowed;\n    }\n    \n    .slot-card.slot-full {\n      background-color: #fff3cd;\n      border-left: 4px solid #ffc107;\n    }\n    \n    .slot-header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 5px;\n    }\n    \n    .slot-header strong {\n      font-size: 0.9rem;\n    }\n    \n    .slot-header small {\n      font-size: 0.75rem;\n      color: #6c757d;\n    }\n    \n    .slot-label {\n      font-size: 0.85rem;\n      margin-bottom: 5px;\n      color: #495057;\n    }\n    \n    .slot-info {\n      font-size: 0.85rem;\n    }\n    \n    .progress-bar.bg-success {\n      background-color: #28a745 !important;\n    }\n    \n    .progress-bar.bg-warning {\n      background-color: #ffc107 !important;\n    }\n    \n    .progress-bar.bg-danger {\n      background-color: #dc3545 !important;\n    }\n    \n    .week-controls {\n      display: flex;\n      align-items: center;\n      flex-wrap: wrap;\n      gap: 10px;\n    }\n    \n    .loading-container {\n      min-height: 400px;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n    }\n  `]\n})\nexport class DashboardComponent implements OnInit {\n  weekData: any[] = [];\n  startDate: string = '';\n  loading: boolean = false;\n  errorMessage: string = '';\n\n  constructor(\n    private apiService: ApiService,\n    private router: Router\n  ) { }\n\n  ngOnInit(): void {\n    this.currentWeek();\n  }\n\n  loadWeek(): void {\n    this.loading = true;\n    this.errorMessage = '';\n    \n    this.apiService.getWeekOverview(this.startDate).subscribe({\n      next: (response) => {\n        this.weekData = response.week_data || [];\n        this.startDate = response.start_date;\n        this.loading = false;\n      },\n      error: (error) => {\n        console.error('Error loading week overview:', error);\n        this.errorMessage = 'Fehler beim Laden der Wochenübersicht';\n        this.loading = false;\n      }\n    });\n  }\n\n  currentWeek(): void {\n    const today = new Date();\n    const monday = new Date(today);\n    const dayOfWeek = today.getDay();\n    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n    monday.setDate(today.getDate() + diff);\n    \n    this.startDate = this.formatDateForAPI(monday);\n    this.loadWeek();\n  }\n\n  previousWeek(): void {\n    const date = new Date(this.startDate);\n    date.setDate(date.getDate() - 7);\n    this.startDate = this.formatDateForAPI(date);\n    this.loadWeek();\n  }\n\n  nextWeek(): void {\n    const date = new Date(this.startDate);\n    date.setDate(date.getDate() + 7);\n    this.startDate = this.formatDateForAPI(date);\n    this.loadWeek();\n  }\n\n  selectSlot(date: string, slot: any): void {\n    if (slot.is_blocked) return;\n    \n    if (slot.is_available) {\n      this.router.navigate(['/book', date, slot.period]);\n    }\n  }\n\n  getSlotClass(slot: any): string {\n    if (slot.is_blocked) return 'slot-blocked';\n    if (slot.is_available) return 'slot-available';\n    return 'slot-full';\n  }\n\n  getProgressPercent(slot: any): number {\n    if (slot.max_students === 0) return 0;\n    return (slot.current_students / slot.max_students) * 100;\n  }\n\n  getProgressClass(slot: any): string {\n    const percent = this.getProgressPercent(slot);\n    if (percent < 50) return 'bg-success';\n    if (percent < 90) return 'bg-warning';\n    return 'bg-danger';\n  }\n\n  getWeekdayName(weekday: string): string {\n    const days: { [key: string]: string } = {\n      'Monday': 'Montag',\n      'Tuesday': 'Dienstag',\n      'Wednesday': 'Mittwoch',\n      'Thursday': 'Donnerstag',\n      'Friday': 'Freitag',\n      'Saturday': 'Samstag',\n      'Sunday': 'Sonntag'\n    };\n    return days[weekday] || weekday;\n  }\n\n  formatDate(dateStr: string): string {\n    if (!dateStr) return '';\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('de-DE', { \n      day: '2-digit', \n      month: '2-digit', \n      year: 'numeric' \n    });\n  }\n\n  formatDateShort(dateStr: string): string {\n    if (!dateStr) return '';\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('de-DE', { \n      day: '2-digit', \n      month: '2-digit'\n    });\n  }\n\n  formatDateForAPI(date: Date): string {\n    const year = date.getFullYear();\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const day = String(date.getDate()).padStart(2, '0');\n    return `${year}-${month}-${day}`;\n  }\n}\n","size_bytes":9965},"backend/manage.py":{"content":"#!/usr/bin/env python\nimport os\nimport sys\n\nif __name__ == '__main__':\n    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')\n    try:\n        from django.core.management import execute_from_command_line\n    except ImportError as exc:\n        raise ImportError(\n            \"Couldn't import Django. Are you sure it's installed and \"\n            \"available on your PYTHONPATH environment variable? Did you \"\n            \"forget to activate a virtual environment?\"\n        ) from exc\n    execute_from_command_line(sys.argv)\n","size_bytes":539},"backend/models.py":{"content":"from django.db import models\nfrom django.contrib.auth.models import User\nfrom django.utils import timezone\nimport json\n\n\nclass TimeSlot(models.Model):\n    \"\"\"Zeitslots mit anpassbaren Namen für verschiedene Perioden\"\"\"\n    WEEKDAY_CHOICES = [\n        ('Mon', 'Montag'),\n        ('Tue', 'Dienstag'),\n        ('Wed', 'Mittwoch'),\n        ('Thu', 'Donnerstag'),\n        ('Fri', 'Freitag'),\n    ]\n    \n    weekday = models.CharField(max_length=3, choices=WEEKDAY_CHOICES)\n    period = models.IntegerField()\n    label = models.CharField(max_length=200)\n    start_time = models.TimeField()\n    end_time = models.TimeField()\n    max_students = models.IntegerField(default=200)\n    \n    class Meta:\n        unique_together = ['weekday', 'period']\n        ordering = ['weekday', 'period']\n        db_table = 'sportoase_timeslots'\n    \n    def __str__(self):\n        return f\"{self.get_weekday_display()} - {self.period}. Stunde: {self.label}\"\n\n\nclass Booking(models.Model):\n    \"\"\"Buchung einer Sportstunde durch eine Lehrkraft\"\"\"\n    OFFER_TYPE_CHOICES = [\n        ('sport', 'Sport'),\n        ('games', 'Spiele'),\n        ('outdoor', 'Outdoor'),\n        ('other', 'Sonstiges'),\n    ]\n    \n    date = models.DateField(db_index=True)\n    weekday = models.CharField(max_length=3)\n    period = models.IntegerField()\n    \n    teacher = models.ForeignKey(User, on_delete=models.CASCADE, related_name='sportoase_bookings')\n    teacher_name = models.CharField(max_length=100)\n    teacher_class = models.CharField(max_length=50, blank=True)\n    \n    students_json = models.TextField()\n    offer_type = models.CharField(max_length=10, choices=OFFER_TYPE_CHOICES)\n    offer_label = models.CharField(max_length=100)\n    \n    calendar_event_id = models.CharField(max_length=200, blank=True, null=True)\n    \n    created_at = models.DateTimeField(default=timezone.now, db_index=True)\n    updated_at = models.DateTimeField(auto_now=True)\n    \n    class Meta:\n        ordering = ['-date', 'period']\n        db_table = 'sportoase_bookings'\n        indexes = [\n            models.Index(fields=['date', 'period']),\n            models.Index(fields=['teacher']),\n        ]\n    \n    def __str__(self):\n        return f\"{self.date} - {self.period}. Stunde: {self.offer_label} ({self.teacher_name})\"\n    \n    @property\n    def students(self):\n        \"\"\"Parse students from JSON\"\"\"\n        try:\n            return json.loads(self.students_json)\n        except:\n            return []\n    \n    @students.setter\n    def students(self, value):\n        \"\"\"Set students as JSON\"\"\"\n        self.students_json = json.dumps(value, ensure_ascii=False)\n    \n    @property\n    def student_count(self):\n        \"\"\"Count of students in this booking\"\"\"\n        return len(self.students)\n    \n    def to_dict(self):\n        \"\"\"Convert to dictionary for API responses\"\"\"\n        return {\n            'id': self.id,\n            'date': self.date.strftime('%Y-%m-%d'),\n            'weekday': self.weekday,\n            'period': self.period,\n            'teacher_id': self.teacher.id,\n            'teacher_name': self.teacher_name,\n            'teacher_class': self.teacher_class,\n            'teacher_email': self.teacher.email,\n            'students': self.students,\n            'student_count': self.student_count,\n            'offer_type': self.offer_type,\n            'offer_label': self.offer_label,\n            'calendar_event_id': self.calendar_event_id,\n            'created_at': self.created_at.isoformat(),\n            'updated_at': self.updated_at.isoformat(),\n        }\n\n\nclass BlockedSlot(models.Model):\n    \"\"\"Von Admins blockierte Slots (z.B. für Beratungsgespräche)\"\"\"\n    date = models.DateField(db_index=True)\n    weekday = models.CharField(max_length=3)\n    period = models.IntegerField()\n    reason = models.CharField(max_length=200, default='Beratung')\n    \n    blocked_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='sportoase_blocked_slots')\n    created_at = models.DateTimeField(default=timezone.now)\n    \n    class Meta:\n        unique_together = ['date', 'period']\n        ordering = ['-date', 'period']\n        db_table = 'sportoase_blocked_slots'\n        indexes = [\n            models.Index(fields=['date', 'period']),\n        ]\n    \n    def __str__(self):\n        return f\"{self.date} - {self.period}. Stunde: Blockiert ({self.reason})\"\n    \n    def to_dict(self):\n        \"\"\"Convert to dictionary for API responses\"\"\"\n        return {\n            'id': self.id,\n            'date': self.date.strftime('%Y-%m-%d'),\n            'weekday': self.weekday,\n            'period': self.period,\n            'reason': self.reason,\n            'blocked_by': self.blocked_by.username,\n            'blocked_by_id': self.blocked_by.id,\n            'created_at': self.created_at.isoformat(),\n        }\n\n\nclass Notification(models.Model):\n    \"\"\"Benachrichtigungen für Admins über neue Buchungen\"\"\"\n    NOTIFICATION_TYPES = [\n        ('new_booking', 'Neue Buchung'),\n        ('booking_updated', 'Buchung aktualisiert'),\n        ('booking_deleted', 'Buchung gelöscht'),\n        ('slot_blocked', 'Slot blockiert'),\n    ]\n    \n    booking = models.ForeignKey(Booking, on_delete=models.CASCADE, related_name='notifications', null=True, blank=True)\n    notification_type = models.CharField(max_length=50, choices=NOTIFICATION_TYPES)\n    message = models.CharField(max_length=500)\n    \n    is_read = models.BooleanField(default=False, db_index=True)\n    read_at = models.DateTimeField(null=True, blank=True)\n    created_at = models.DateTimeField(default=timezone.now, db_index=True)\n    \n    metadata_json = models.TextField(blank=True)\n    \n    class Meta:\n        ordering = ['-created_at']\n        db_table = 'sportoase_notifications'\n    \n    def __str__(self):\n        return f\"{self.get_notification_type_display()}: {self.message[:50]}\"\n    \n    @property\n    def metadata(self):\n        \"\"\"Parse metadata from JSON\"\"\"\n        if not self.metadata_json:\n            return {}\n        try:\n            return json.loads(self.metadata_json)\n        except:\n            return {}\n    \n    @metadata.setter\n    def metadata(self, value):\n        \"\"\"Set metadata as JSON\"\"\"\n        self.metadata_json = json.dumps(value, ensure_ascii=False)\n    \n    def to_dict(self):\n        \"\"\"Convert to dictionary for API responses\"\"\"\n        return {\n            'id': self.id,\n            'booking_id': self.booking.id if self.booking else None,\n            'notification_type': self.notification_type,\n            'message': self.message,\n            'is_read': self.is_read,\n            'read_at': self.read_at.isoformat() if self.read_at else None,\n            'created_at': self.created_at.isoformat(),\n            'metadata': self.metadata,\n        }\n","size_bytes":6732},"backend/views/slots.py":{"content":"from django.http import JsonResponse, HttpResponseForbidden\nfrom django.views.decorators.http import require_http_methods\nfrom django.views.decorators.csrf import csrf_exempt\nfrom datetime import datetime, timedelta\nfrom backend.services.booking_service import BookingService\nfrom backend.models import TimeSlot\nimport json\n\n\n@require_http_methods([\"GET\"])\ndef get_available_slots(request):\n    \"\"\"GET /api/sportoase/slots - Gibt verfügbare Slots zurück\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.user\"):\n        return HttpResponseForbidden(\"Keine Berechtigung\")\n    \n    date_str = request.GET.get('date')\n    if not date_str:\n        return JsonResponse({'error': 'Datum erforderlich'}, status=400)\n    \n    try:\n        date = datetime.strptime(date_str, '%Y-%m-%d').date()\n    except ValueError:\n        return JsonResponse({'error': 'Ungültiges Datumsformat (YYYY-MM-DD erwartet)'}, status=400)\n    \n    slots = BookingService.get_available_slots(date, request.user)\n    \n    return JsonResponse({\n        'success': True,\n        'date': date_str,\n        'slots': slots\n    })\n\n\n@require_http_methods([\"GET\"])\ndef get_week_overview(request):\n    \"\"\"GET /api/sportoase/slots/week - Gibt Übersicht für eine Woche zurück\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.user\"):\n        return HttpResponseForbidden(\"Keine Berechtigung\")\n    \n    start_date_str = request.GET.get('start_date')\n    if not start_date_str:\n        today = datetime.now().date()\n        start_date = today - timedelta(days=today.weekday())\n    else:\n        try:\n            start_date = datetime.strptime(start_date_str, '%Y-%m-%d').date()\n        except ValueError:\n            return JsonResponse({'error': 'Ungültiges Datumsformat'}, status=400)\n    \n    week_data = []\n    for i in range(5):\n        date = start_date + timedelta(days=i)\n        slots = BookingService.get_available_slots(date)\n        week_data.append({\n            'date': date.strftime('%Y-%m-%d'),\n            'weekday': date.strftime('%A'),\n            'slots': slots\n        })\n    \n    return JsonResponse({\n        'success': True,\n        'start_date': start_date.strftime('%Y-%m-%d'),\n        'week_data': week_data\n    })\n\n\n@require_http_methods([\"GET\"])\ndef get_timeslots(request):\n    \"\"\"GET /api/sportoase/timeslots - Gibt alle konfigurierten Zeitslots zurück\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    timeslots = TimeSlot.objects.all().order_by('weekday', 'period')\n    \n    return JsonResponse({\n        'success': True,\n        'timeslots': [{\n            'id': ts.id,\n            'weekday': ts.weekday,\n            'period': ts.period,\n            'label': ts.label,\n            'start_time': ts.start_time.strftime('%H:%M'),\n            'end_time': ts.end_time.strftime('%H:%M'),\n            'max_students': ts.max_students,\n        } for ts in timeslots]\n    })\n","size_bytes":3167},"backend/settings.py":{"content":"import os\nfrom pathlib import Path\n\nBASE_DIR = Path(__file__).resolve().parent.parent\n\nSECRET_KEY = os.environ.get('DJANGO_SECRET_KEY', 'dev-secret-key-change-in-production')\n\nDEBUG = os.environ.get('DEBUG', 'True') == 'True'\n\nALLOWED_HOSTS = ['*']\n\nINSTALLED_APPS = [\n    'django.contrib.admin',\n    'django.contrib.auth',\n    'django.contrib.contenttypes',\n    'django.contrib.sessions',\n    'django.contrib.messages',\n    'django.contrib.staticfiles',\n    'corsheaders',\n    'backend',\n]\n\nMIDDLEWARE = [\n    'django.middleware.security.SecurityMiddleware',\n    'django.contrib.sessions.middleware.SessionMiddleware',\n    'corsheaders.middleware.CorsMiddleware',\n    'django.middleware.common.CommonMiddleware',\n    'django.middleware.csrf.CsrfViewMiddleware',\n    'django.contrib.auth.middleware.AuthenticationMiddleware',\n    'django.contrib.messages.middleware.MessageMiddleware',\n    'django.middleware.clickjacking.XFrameOptionsMiddleware',\n]\n\nROOT_URLCONF = 'backend.main_urls'\n\nTEMPLATES = [\n    {\n        'BACKEND': 'django.template.backends.django.DjangoTemplates',\n        'DIRS': [BASE_DIR / 'templates'],\n        'APP_DIRS': True,\n        'OPTIONS': {\n            'context_processors': [\n                'django.template.context_processors.debug',\n                'django.template.context_processors.request',\n                'django.contrib.auth.context_processors.auth',\n                'django.contrib.messages.context_processors.messages',\n            ],\n        },\n    },\n]\n\nWSGI_APPLICATION = 'backend.wsgi.application'\n\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.sqlite3',\n        'NAME': BASE_DIR / 'db.sqlite3',\n    }\n}\n\nAUTH_PASSWORD_VALIDATORS = [\n    {\n        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',\n    },\n    {\n        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',\n    },\n]\n\nLANGUAGE_CODE = 'de-de'\n\nTIME_ZONE = 'Europe/Berlin'\n\nUSE_I18N = True\n\nUSE_TZ = True\n\nSTATIC_URL = '/static/'\nSTATIC_ROOT = BASE_DIR / 'staticfiles'\n\nDEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'\n\nCSRF_COOKIE_SECURE = False\nSESSION_COOKIE_SECURE = False\nCSRF_COOKIE_HTTPONLY = True\nCSRF_COOKIE_SAMESITE = 'Lax'\nCSRF_TRUSTED_ORIGINS = ['http://localhost:4200', 'http://127.0.0.1:4200', 'http://localhost:5000']\n\nCORS_ALLOW_ALL_ORIGINS = DEBUG\nCORS_ALLOW_CREDENTIALS = True\nCORS_ALLOWED_ORIGINS = [\n    'http://localhost:4200',\n    'http://127.0.0.1:4200',\n]\n\nPERIOD_TIMES = {\n    1: {'start': '08:00', 'end': '08:45'},\n    2: {'start': '08:50', 'end': '09:35'},\n    3: {'start': '09:55', 'end': '10:40'},\n    4: {'start': '10:45', 'end': '11:30'},\n    5: {'start': '11:50', 'end': '12:35'},\n    6: {'start': '12:40', 'end': '13:25'},\n}\n","size_bytes":2744},"backend/main_urls.py":{"content":"from django.contrib import admin\nfrom django.urls import path, include\n\nurlpatterns = [\n    path('admin/', admin.site.urls),\n    path('api/sportoase/', include('backend.urls')),\n]\n","size_bytes":180},"backend/init_data.py":{"content":"#!/usr/bin/env python\n\"\"\"Initialize SportOase database with default timeslots\"\"\"\nimport os\nimport sys\nimport django\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')\nsys.path.insert(0, '/home/runner/workspace')\n\ndjango.setup()\n\nfrom backend.models import TimeSlot\nfrom datetime import time\n\ndef create_timeslots():\n    \"\"\"Create default timeslots for each weekday\"\"\"\n    periods = [\n        {'period': 1, 'label': '1. Stunde', 'start': time(8, 0), 'end': time(8, 45)},\n        {'period': 2, 'label': '2. Stunde', 'start': time(8, 50), 'end': time(9, 35)},\n        {'period': 3, 'label': '3. Stunde', 'start': time(9, 55), 'end': time(10, 40)},\n        {'period': 4, 'label': '4. Stunde', 'start': time(10, 45), 'end': time(11, 30)},\n        {'period': 5, 'label': '5. Stunde', 'start': time(11, 50), 'end': time(12, 35)},\n        {'period': 6, 'label': '6. Stunde', 'start': time(12, 40), 'end': time(13, 25)},\n    ]\n    \n    weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']\n    \n    created_count = 0\n    for weekday in weekdays:\n        for period_data in periods:\n            timeslot, created = TimeSlot.objects.get_or_create(\n                weekday=weekday,\n                period=period_data['period'],\n                defaults={\n                    'label': period_data['label'],\n                    'start_time': period_data['start'],\n                    'end_time': period_data['end'],\n                    'max_students': 200\n                }\n            )\n            if created:\n                created_count += 1\n                print(f\"✓ Created: {weekday} - {period_data['label']}\")\n            else:\n                print(f\"  Exists: {weekday} - {period_data['label']}\")\n    \n    print(f\"\\n✅ Done! Created {created_count} new timeslots.\")\n    print(f\"Total timeslots in database: {TimeSlot.objects.count()}\")\n\nif __name__ == '__main__':\n    print(\"Initializing SportOase timeslots...\")\n    create_timeslots()\n","size_bytes":1947},"frontend/src/app/components/admin-panel/admin-panel.component.ts":{"content":"import { Component, OnInit } from '@angular/core';\nimport { FormBuilder, FormGroup, Validators } from '@angular/forms';\nimport { ApiService } from '../../services/api.service';\n\n@Component({\n  selector: 'app-admin-panel',\n  template: `\n    <div class=\"card\">\n      <h2>Admin-Panel</h2>\n      <p class=\"text-muted\">Slots blockieren und Benachrichtigungen verwalten</p>\n      \n      <h4 class=\"mt-4\">Slot blockieren</h4>\n      <form [formGroup]=\"blockForm\" (ngSubmit)=\"blockSlot()\">\n        <div class=\"row\">\n          <div class=\"col-md-4\">\n            <label class=\"form-label\">Datum</label>\n            <input type=\"date\" class=\"form-control\" formControlName=\"date\">\n          </div>\n          <div class=\"col-md-2\">\n            <label class=\"form-label\">Stunde</label>\n            <input type=\"number\" class=\"form-control\" formControlName=\"period\" min=\"1\" max=\"6\">\n          </div>\n          <div class=\"col-md-4\">\n            <label class=\"form-label\">Grund</label>\n            <input type=\"text\" class=\"form-control\" formControlName=\"reason\" placeholder=\"Beratung\">\n          </div>\n          <div class=\"col-md-2\">\n            <label class=\"form-label\">&nbsp;</label>\n            <button type=\"submit\" class=\"btn btn-warning w-100\" [disabled]=\"!blockForm.valid\">\n              Blockieren\n            </button>\n          </div>\n        </div>\n      </form>\n      \n      <div *ngIf=\"successMessage\" class=\"alert alert-success mt-3\">\n        {{ successMessage }}\n      </div>\n      \n      <div *ngIf=\"errorMessage\" class=\"alert alert-danger mt-3\">\n        {{ errorMessage }}\n      </div>\n      \n      <h4 class=\"mt-4\">Blockierte Slots</h4>\n      <div *ngIf=\"loadingBlocked\" class=\"text-center\">\n        <div class=\"spinner-border\" role=\"status\"></div>\n      </div>\n      \n      <div *ngIf=\"!loadingBlocked && blockedSlots.length > 0\">\n        <table class=\"table table-striped\">\n          <thead>\n            <tr>\n              <th>Datum</th>\n              <th>Stunde</th>\n              <th>Grund</th>\n              <th>Blockiert von</th>\n              <th>Aktionen</th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr *ngFor=\"let slot of blockedSlots\">\n              <td>{{ slot.date }}</td>\n              <td>{{ slot.period }}. Stunde</td>\n              <td>{{ slot.reason }}</td>\n              <td>{{ slot.blocked_by }}</td>\n              <td>\n                <button class=\"btn btn-sm btn-success\" (click)=\"unblockSlot(slot)\">\n                  Freigeben\n                </button>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n      \n      <div *ngIf=\"!loadingBlocked && blockedSlots.length === 0\" class=\"alert alert-info\">\n        Keine blockierten Slots vorhanden.\n      </div>\n    </div>\n  `,\n  styles: []\n})\nexport class AdminPanelComponent implements OnInit {\n  blockForm: FormGroup;\n  blockedSlots: any[] = [];\n  loadingBlocked: boolean = false;\n  successMessage: string = '';\n  errorMessage: string = '';\n\n  constructor(\n    private fb: FormBuilder,\n    private apiService: ApiService\n  ) {\n    this.blockForm = this.fb.group({\n      date: ['', Validators.required],\n      period: ['', [Validators.required, Validators.min(1), Validators.max(6)]],\n      reason: ['Beratung']\n    });\n  }\n\n  ngOnInit(): void {\n    this.loadBlockedSlots();\n  }\n\n  loadBlockedSlots(): void {\n    this.loadingBlocked = true;\n    this.apiService.getBlockedSlots().subscribe({\n      next: (response) => {\n        this.blockedSlots = response.blocked_slots || [];\n        this.loadingBlocked = false;\n      },\n      error: (error) => {\n        console.error('Error loading blocked slots:', error);\n        this.loadingBlocked = false;\n      }\n    });\n  }\n\n  blockSlot(): void {\n    if (!this.blockForm.valid) return;\n    \n    const formValue = this.blockForm.value;\n    const slotData = {\n      date: formValue.date,\n      weekday: this.getWeekday(formValue.date),\n      period: parseInt(formValue.period),\n      reason: formValue.reason || 'Beratung'\n    };\n    \n    this.apiService.blockSlot(slotData).subscribe({\n      next: (response) => {\n        this.successMessage = 'Slot erfolgreich blockiert';\n        this.blockForm.reset({ reason: 'Beratung' });\n        this.loadBlockedSlots();\n        setTimeout(() => this.successMessage = '', 3000);\n      },\n      error: (error) => {\n        this.errorMessage = error.error?.error || 'Fehler beim Blockieren des Slots';\n        setTimeout(() => this.errorMessage = '', 3000);\n      }\n    });\n  }\n\n  unblockSlot(slot: any): void {\n    if (!confirm(`Möchten Sie den Slot am ${slot.date} (${slot.period}. Stunde) wirklich freigeben?`)) {\n      return;\n    }\n    \n    const slotData = {\n      date: slot.date,\n      period: slot.period\n    };\n    \n    this.apiService.unblockSlot(slotData).subscribe({\n      next: (response) => {\n        this.successMessage = 'Slot erfolgreich freigegeben';\n        this.loadBlockedSlots();\n        setTimeout(() => this.successMessage = '', 3000);\n      },\n      error: (error) => {\n        this.errorMessage = error.error?.error || 'Fehler beim Freigeben des Slots';\n        setTimeout(() => this.errorMessage = '', 3000);\n      }\n    });\n  }\n\n  private getWeekday(dateStr: string): string {\n    const date = new Date(dateStr);\n    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n    return days[date.getDay()];\n  }\n}\n","size_bytes":5370},"backend/services/__init__.py":{"content":"# SportOase Services Package\n","size_bytes":29},"backend/views/bookings.py":{"content":"from django.http import JsonResponse, HttpResponseForbidden\nfrom django.views.decorators.http import require_http_methods\nfrom datetime import datetime\nfrom backend.services.booking_service import BookingService\nfrom backend.models import Booking\nimport json\n\n\n@require_http_methods([\"POST\"])\ndef create_booking(request):\n    \"\"\"POST /api/sportoase/book - Erstellt eine neue Buchung\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.user\"):\n        return HttpResponseForbidden(\"Keine Berechtigung\")\n    \n    try:\n        data = json.loads(request.body)\n    except json.JSONDecodeError:\n        return JsonResponse({'success': False, 'error': 'Ungültige JSON-Daten'}, status=400)\n    \n    required_fields = ['date', 'weekday', 'period', 'students', 'offer_type', 'offer_label']\n    for field in required_fields:\n        if field not in data:\n            return JsonResponse({'success': False, 'error': f'Feld \"{field}\" fehlt'}, status=400)\n    \n    try:\n        date = datetime.strptime(data['date'], '%Y-%m-%d').date()\n    except ValueError:\n        return JsonResponse({'success': False, 'error': 'Ungültiges Datumsformat'}, status=400)\n    \n    try:\n        booking = BookingService.create_booking(\n            date=date,\n            weekday=data['weekday'],\n            period=data['period'],\n            teacher=request.user,\n            students=data['students'],\n            offer_type=data['offer_type'],\n            offer_label=data['offer_label'],\n            teacher_name=data.get('teacher_name'),\n            teacher_class=data.get('teacher_class'),\n        )\n        \n        return JsonResponse({\n            'success': True,\n            'message': 'Buchung erfolgreich erstellt',\n            'booking': booking.to_dict()\n        })\n    \n    except ValueError as e:\n        return JsonResponse({'success': False, 'error': str(e)}, status=400)\n    except Exception as e:\n        return JsonResponse({'success': False, 'error': f'Fehler beim Erstellen der Buchung: {str(e)}'}, status=500)\n\n\n@require_http_methods([\"GET\"])\ndef get_my_bookings(request):\n    \"\"\"GET /api/sportoase/my-bookings - Gibt die Buchungen des aktuellen Benutzers zurück\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.user\"):\n        return HttpResponseForbidden(\"Keine Berechtigung\")\n    \n    start_date_str = request.GET.get('start_date')\n    end_date_str = request.GET.get('end_date')\n    \n    start_date = datetime.strptime(start_date_str, '%Y-%m-%d').date() if start_date_str else None\n    end_date = datetime.strptime(end_date_str, '%Y-%m-%d').date() if end_date_str else None\n    \n    bookings = BookingService.get_user_bookings(request.user, start_date, end_date)\n    \n    return JsonResponse({\n        'success': True,\n        'bookings': [b.to_dict() for b in bookings]\n    })\n\n\n@require_http_methods([\"DELETE\"])\ndef delete_booking(request, booking_id):\n    \"\"\"DELETE /api/sportoase/bookings/<id> - Löscht eine Buchung\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.user\"):\n        return HttpResponseForbidden(\"Keine Berechtigung\")\n    \n    try:\n        BookingService.delete_booking(booking_id, request.user)\n        return JsonResponse({\n            'success': True,\n            'message': 'Buchung erfolgreich gelöscht'\n        })\n    \n    except ValueError as e:\n        return JsonResponse({'success': False, 'error': str(e)}, status=404)\n    except PermissionError as e:\n        return JsonResponse({'success': False, 'error': str(e)}, status=403)\n    except Exception as e:\n        return JsonResponse({'success': False, 'error': f'Fehler beim Löschen: {str(e)}'}, status=500)\n\n\n@require_http_methods([\"GET\"])\ndef get_all_bookings(request):\n    \"\"\"GET /api/sportoase/bookings - Gibt alle Buchungen zurück (Admin only)\"\"\"\n    if not request.user.is_authenticated:\n        return HttpResponseForbidden(\"Authentifizierung erforderlich\")\n    \n    if not request.user.has_perm(\"sportoase.admin\"):\n        return HttpResponseForbidden(\"Nur für Admins\")\n    \n    date_str = request.GET.get('date')\n    \n    if date_str:\n        try:\n            date = datetime.strptime(date_str, '%Y-%m-%d').date()\n            bookings = Booking.objects.filter(date=date).order_by('period')\n        except ValueError:\n            return JsonResponse({'error': 'Ungültiges Datumsformat'}, status=400)\n    else:\n        bookings = Booking.objects.all().order_by('-date', 'period')[:100]\n    \n    return JsonResponse({\n        'success': True,\n        'bookings': [b.to_dict() for b in bookings]\n    })\n","size_bytes":4838},"backend/wsgi.py":{"content":"import os\nfrom django.core.wsgi import get_wsgi_application\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')\n\napplication = get_wsgi_application()\n","size_bytes":167},"frontend/src/styles.css":{"content":"/* Global Styles für SportOase */\n:root {\n  --primary-color: #2c5aa0;\n  --secondary-color: #5a8ed9;\n  --success-color: #28a745;\n  --danger-color: #dc3545;\n  --warning-color: #ffc107;\n  --light-bg: #f8f9fa;\n  --border-color: #dee2e6;\n}\n\nbody {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n  margin: 0;\n  padding: 0;\n  background-color: var(--light-bg);\n}\n\n.container {\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 20px;\n}\n\n.card {\n  background: white;\n  border-radius: 8px;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n  padding: 20px;\n  margin-bottom: 20px;\n}\n\n.btn-primary {\n  background-color: var(--primary-color) !important;\n  border-color: var(--primary-color) !important;\n}\n\n.btn-primary:hover {\n  background-color: var(--secondary-color) !important;\n  border-color: var(--secondary-color) !important;\n}\n\n.table {\n  background: white;\n}\n\n.navbar {\n  background-color: var(--primary-color) !important;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n}\n\n.slot-available {\n  background-color: #d4edda;\n  border-left: 4px solid var(--success-color);\n}\n\n.slot-blocked {\n  background-color: #f8d7da;\n  border-left: 4px solid var(--danger-color);\n}\n\n.slot-full {\n  background-color: #fff3cd;\n  border-left: 4px solid var(--warning-color);\n}\n\n.spinner-border {\n  width: 3rem;\n  height: 3rem;\n}\n\n.loading-container {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 400px;\n}\n","size_bytes":1467},"backend/__init__.py":{"content":"# SportOase IServ Module - Backend Package\n","size_bytes":43},"backend/views/__init__.py":{"content":"# SportOase Views Package\n","size_bytes":26},"README.md":{"content":"# SportOase - IServ Buchungssystem\n\nEin vollständiges IServ-Modul für die Verwaltung und Buchung von Sportstunden.\n\n## Übersicht\n\nSportOase ist ein Buchungssystem, das vollständig in IServ integriert ist und IServs interne Benutzer- und Rechteverwaltung nutzt. Es ermöglicht Lehrkräften, Sportstunden zu buchen und Administratoren, Zeitslots zu blockieren.\n\n## Features\n\n- ✅ **Slot-Verwaltung**: Anzeige verfügbarer Zeitslots mit Echtzeitinformationen\n- ✅ **Buchungssystem**: Einfache Buchung von Sportstunden für Klassen\n- ✅ **Benutzerrechte**: Integration mit IServ-Berechtigungssystem (sportoase.user, sportoase.admin)\n- ✅ **Admin-Panel**: Blockierung von Slots für Beratungsgespräche\n- ✅ **Django Backend**: RESTful API mit Django und Django REST Framework\n- ✅ **Angular Frontend**: Moderne, responsive Benutzeroberfläche\n- ✅ **Docker-Ready**: Vollständige Docker-Konfiguration für Entwicklung und Deployment\n\n## Architektur\n\n### Backend (Django)\n```\nbackend/\n├── models.py           # Datenmodelle (Booking, TimeSlot, BlockedSlot, Notification)\n├── services/\n│   └── booking_service.py  # Business-Logik\n├── views/\n│   ├── slots.py        # Slot-Endpunkte\n│   ├── bookings.py     # Buchungs-Endpunkte\n│   └── admin.py        # Admin-Endpunkte\n├── urls.py             # URL-Routing\n├── settings.py         # Django-Konfiguration\n└── manage.py           # Django Management\n```\n\n### Frontend (Angular)\n```\nfrontend/src/app/\n├── components/\n│   ├── dashboard/      # Hauptseite\n│   ├── slots/          # Slot-Übersicht\n│   ├── booking-form/   # Buchungsformular\n│   ├── my-bookings/    # Meine Buchungen\n│   └── admin-panel/    # Admin-Verwaltung\n├── services/\n│   └── api.service.ts  # API-Kommunikation\n└── app.module.ts       # Angular Hauptmodul\n```\n\n## Installation\n\n### 1. IServ-Kompatibilität\n\nDieses Modul ist für IServ 3.x konzipiert und nutzt:\n- IServ-Benutzer (`request.user`)\n- IServ-Berechtigungen (`sportoase.user`, `sportoase.admin`)\n- IServ-Datenbank (MariaDB/MySQL oder SQLite für Entwicklung)\n\n### 2. Abhängigkeiten installieren\n\n**Backend:**\n```bash\npip install -r requirements.txt\n```\n\n**Frontend:**\n```bash\ncd frontend\nnpm install\n```\n\n### 3. Datenbank einrichten\n\n```bash\npython backend/manage.py migrate\npython backend/manage.py createsuperuser\n```\n\n### 4. Beispiel-Zeitslots erstellen\n\n```python\npython backend/manage.py shell\n\nfrom backend.models import TimeSlot\nfrom datetime import time\n\n# Erstelle Standard-Zeitslots\nslots = [\n    {'weekday': 'Mon', 'period': 1, 'label': '1. Stunde', 'start_time': time(8, 0), 'end_time': time(8, 45)},\n    {'weekday': 'Mon', 'period': 2, 'label': '2. Stunde', 'start_time': time(8, 50), 'end_time': time(9, 35)},\n    {'weekday': 'Mon', 'period': 3, 'label': '3. Stunde', 'start_time': time(9, 55), 'end_time': time(10, 40)},\n    {'weekday': 'Mon', 'period': 4, 'label': '4. Stunde', 'start_time': time(10, 45), 'end_time': time(11, 30)},\n    {'weekday': 'Mon', 'period': 5, 'label': '5. Stunde', 'start_time': time(11, 50), 'end_time': time(12, 35)},\n    {'weekday': 'Mon', 'period': 6, 'label': '6. Stunde', 'start_time': time(12, 40), 'end_time': time(13, 25)},\n]\n\n# Für jeden Wochentag wiederholen\nweekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']\nfor wd in weekdays:\n    for s in slots:\n        TimeSlot.objects.get_or_create(\n            weekday=wd,\n            period=s['period'],\n            defaults={\n                'label': s['label'],\n                'start_time': s['start_time'],\n                'end_time': s['end_time'],\n                'max_students': 200\n            }\n        )\n```\n\n### 5. Rechte vergeben\n\nIn der IServ-Admin-Oberfläche:\n1. Navigieren Sie zu **Benutzer & Gruppen** → **Berechtigungen**\n2. Weisen Sie `sportoase.user` allen Lehrkräften zu\n3. Weisen Sie `sportoase.admin` Administratoren zu\n\n## Verwendung\n\n### Für Lehrkräfte (sportoase.user)\n\n1. **Dashboard**: Übersicht über das System\n2. **Slots anzeigen**: Verfügbare Zeitslots für ein gewähltes Datum sehen\n3. **Slot buchen**: \n   - Datum und Stunde auswählen\n   - Angebotsart und -bezeichnung eingeben\n   - Schüler hinzufügen\n   - Buchung absenden\n4. **Meine Buchungen**: Eigene Buchungen verwalten und löschen\n\n### Für Administratoren (sportoase.admin)\n\nZusätzlich zu den Lehrkraft-Funktionen:\n- **Slots blockieren**: Zeitslots für Beratungsgespräche oder andere Zwecke blockieren\n- **Blockierte Slots verwalten**: Blockierungen aufheben\n- **Alle Buchungen sehen**: Übersicht aller Buchungen im System\n\n## API-Endpunkte\n\n### Slots\n- `GET /api/sportoase/slots?date=YYYY-MM-DD` - Verfügbare Slots abrufen\n- `GET /api/sportoase/timeslots` - Alle konfigurierten Zeitslots\n\n### Buchungen\n- `POST /api/sportoase/book` - Neue Buchung erstellen\n- `GET /api/sportoase/my-bookings` - Eigene Buchungen abrufen\n- `GET /api/sportoase/bookings` - Alle Buchungen (Admin)\n- `DELETE /api/sportoase/bookings/<id>` - Buchung löschen\n\n### Admin\n- `POST /api/sportoase/block-slot` - Slot blockieren (Admin)\n- `POST /api/sportoase/unblock-slot` - Slot freigeben (Admin)\n- `GET /api/sportoase/blocked-slots` - Blockierte Slots abrufen\n\n## Entwicklung\n\n### Backend-Server starten\n```bash\npython backend/manage.py runserver 0.0.0.0:8000\n```\n\n### Frontend-Server starten\n```bash\ncd frontend\nnpm start\n```\n\nDas Frontend läuft auf `http://localhost:4200` und kommuniziert mit dem Backend auf Port 8000.\n\n## Docker-Deployment\n\n```bash\ndocker-compose up -d\n```\n\n## Erweiterungen\n\n### Neue Features hinzufügen\n\n1. **Backend**: Erweitern Sie `backend/models.py`, `backend/services/booking_service.py` und Views\n2. **Frontend**: Erstellen Sie neue Komponenten in `frontend/src/app/components/`\n3. **API**: Fügen Sie neue Endpunkte in `backend/urls.py` hinzu\n\n### Anpassungen\n\n- **Zeitslots**: Ändern Sie die Zeitslots in der Datenbank oder `backend/settings.py`\n- **Maximale Schüleranzahl**: Passen Sie `max_students` in den TimeSlot-Objekten an\n- **Styling**: Bearbeiten Sie `frontend/src/styles.css` für Design-Anpassungen\n\n## Technologie-Stack\n\n- **Backend**: Django 4.2, Django REST Framework\n- **Frontend**: Angular 15, TypeScript, Bootstrap 5\n- **Datenbank**: SQLite (Entwicklung), MariaDB/MySQL (IServ-Produktion)\n- **Deployment**: Docker, Nginx, Gunicorn\n\n## Lizenz\n\nInternes Modul für IServ-Installation\n\n## Support\n\nBei Fragen oder Problemen wenden Sie sich an das SportOase-Team.\n","size_bytes":6507},"frontend/src/app/components/week-overview/week-overview.component.ts":{"content":"import { Component, OnInit } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { ApiService } from '../../services/api.service';\n\n@Component({\n  selector: 'app-week-overview',\n  template: `\n    <div class=\"card\">\n      <h2>Wochenübersicht</h2>\n      <p class=\"lead\">Übersicht aller verfügbaren Slots für die Woche</p>\n      \n      <div class=\"week-controls mb-4\">\n        <button class=\"btn btn-secondary me-2\" (click)=\"previousWeek()\">\n          ← Vorherige Woche\n        </button>\n        <button class=\"btn btn-secondary me-2\" (click)=\"currentWeek()\">\n          Aktuelle Woche\n        </button>\n        <button class=\"btn btn-secondary\" (click)=\"nextWeek()\">\n          Nächste Woche →\n        </button>\n        <span class=\"ms-3 text-muted\">\n          Woche ab {{ formatDate(startDate) }}\n        </span>\n      </div>\n      \n      <div *ngIf=\"loading\" class=\"loading-container\">\n        <div class=\"spinner-border text-primary\" role=\"status\">\n          <span class=\"visually-hidden\">Laden...</span>\n        </div>\n      </div>\n      \n      <div *ngIf=\"!loading && weekData.length > 0\" class=\"week-grid\">\n        <div *ngFor=\"let day of weekData\" class=\"day-column\">\n          <div class=\"day-header\">\n            <h5>{{ getWeekdayName(day.weekday) }}</h5>\n            <small class=\"text-muted\">{{ formatDateShort(day.date) }}</small>\n          </div>\n          \n          <div class=\"slots-container\">\n            <div *ngFor=\"let slot of day.slots\" \n                 class=\"slot-card mb-2\" \n                 [ngClass]=\"getSlotClass(slot)\"\n                 (click)=\"selectSlot(day.date, slot)\">\n              <div class=\"slot-header\">\n                <strong>{{ slot.period }}. Stunde</strong>\n                <small>{{ slot.start_time }} - {{ slot.end_time }}</small>\n              </div>\n              <div class=\"slot-info\">\n                <div *ngIf=\"!slot.is_blocked\">\n                  <small>{{ slot.current_students }}/{{ slot.max_students }}</small>\n                  <div class=\"progress mt-1\" style=\"height: 4px;\">\n                    <div class=\"progress-bar\" \n                         [ngClass]=\"getProgressClass(slot)\"\n                         [style.width.%]=\"getProgressPercent(slot)\">\n                    </div>\n                  </div>\n                </div>\n                <div *ngIf=\"slot.is_blocked\" class=\"text-danger\">\n                  <small><strong>Blockiert</strong></small>\n                </div>\n              </div>\n              <div *ngIf=\"slot.bookings && slot.bookings.length > 0\" class=\"mt-1\">\n                <small class=\"text-muted\">\n                  {{ slot.bookings[0].offer_label }}\n                  <span *ngIf=\"slot.bookings.length > 1\">\n                    +{{ slot.bookings.length - 1 }}\n                  </span>\n                </small>\n              </div>\n            </div>\n            \n            <div *ngIf=\"day.slots.length === 0\" class=\"alert alert-info\">\n              Keine Slots\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <div *ngIf=\"!loading && weekData.length === 0\" class=\"alert alert-warning\">\n        Keine Daten für diese Woche verfügbar\n      </div>\n      \n      <div *ngIf=\"errorMessage\" class=\"alert alert-danger mt-3\">\n        {{ errorMessage }}\n      </div>\n    </div>\n  `,\n  styles: [`\n    .week-grid {\n      display: grid;\n      grid-template-columns: repeat(5, 1fr);\n      gap: 15px;\n      margin-top: 20px;\n    }\n    \n    @media (max-width: 1200px) {\n      .week-grid {\n        grid-template-columns: repeat(3, 1fr);\n      }\n    }\n    \n    @media (max-width: 768px) {\n      .week-grid {\n        grid-template-columns: repeat(2, 1fr);\n      }\n    }\n    \n    @media (max-width: 480px) {\n      .week-grid {\n        grid-template-columns: 1fr;\n      }\n    }\n    \n    .day-column {\n      border: 1px solid #dee2e6;\n      border-radius: 8px;\n      overflow: hidden;\n      background: white;\n    }\n    \n    .day-header {\n      background: linear-gradient(135deg, #2c5aa0 0%, #5a8ed9 100%);\n      color: white;\n      padding: 12px;\n      text-align: center;\n    }\n    \n    .day-header h5 {\n      margin: 0;\n      font-size: 1rem;\n    }\n    \n    .day-header small {\n      color: rgba(255, 255, 255, 0.9);\n    }\n    \n    .slots-container {\n      padding: 10px;\n      max-height: 600px;\n      overflow-y: auto;\n    }\n    \n    .slot-card {\n      padding: 10px;\n      border-radius: 6px;\n      cursor: pointer;\n      transition: transform 0.2s, box-shadow 0.2s;\n      border: 1px solid #dee2e6;\n    }\n    \n    .slot-card:hover {\n      transform: translateY(-2px);\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);\n    }\n    \n    .slot-card.slot-available {\n      background-color: #d4edda;\n      border-left: 4px solid #28a745;\n    }\n    \n    .slot-card.slot-blocked {\n      background-color: #f8d7da;\n      border-left: 4px solid #dc3545;\n      cursor: not-allowed;\n    }\n    \n    .slot-card.slot-full {\n      background-color: #fff3cd;\n      border-left: 4px solid #ffc107;\n    }\n    \n    .slot-header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 5px;\n    }\n    \n    .slot-header strong {\n      font-size: 0.9rem;\n    }\n    \n    .slot-header small {\n      font-size: 0.75rem;\n      color: #6c757d;\n    }\n    \n    .slot-info {\n      font-size: 0.85rem;\n    }\n    \n    .progress-bar.bg-success {\n      background-color: #28a745 !important;\n    }\n    \n    .progress-bar.bg-warning {\n      background-color: #ffc107 !important;\n    }\n    \n    .progress-bar.bg-danger {\n      background-color: #dc3545 !important;\n    }\n    \n    .week-controls {\n      display: flex;\n      align-items: center;\n      flex-wrap: wrap;\n      gap: 10px;\n    }\n    \n    .loading-container {\n      min-height: 400px;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n    }\n  `]\n})\nexport class WeekOverviewComponent implements OnInit {\n  weekData: any[] = [];\n  startDate: string = '';\n  loading: boolean = false;\n  errorMessage: string = '';\n\n  constructor(\n    private apiService: ApiService,\n    private router: Router\n  ) { }\n\n  ngOnInit(): void {\n    this.currentWeek();\n  }\n\n  loadWeek(): void {\n    this.loading = true;\n    this.errorMessage = '';\n    \n    this.apiService.getWeekOverview(this.startDate).subscribe({\n      next: (response) => {\n        this.weekData = response.week_data || [];\n        this.startDate = response.start_date;\n        this.loading = false;\n      },\n      error: (error) => {\n        console.error('Error loading week overview:', error);\n        this.errorMessage = 'Fehler beim Laden der Wochenübersicht';\n        this.loading = false;\n      }\n    });\n  }\n\n  currentWeek(): void {\n    const today = new Date();\n    const monday = new Date(today);\n    const dayOfWeek = today.getDay();\n    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n    monday.setDate(today.getDate() + diff);\n    \n    this.startDate = this.formatDateForAPI(monday);\n    this.loadWeek();\n  }\n\n  previousWeek(): void {\n    const date = new Date(this.startDate);\n    date.setDate(date.getDate() - 7);\n    this.startDate = this.formatDateForAPI(date);\n    this.loadWeek();\n  }\n\n  nextWeek(): void {\n    const date = new Date(this.startDate);\n    date.setDate(date.getDate() + 7);\n    this.startDate = this.formatDateForAPI(date);\n    this.loadWeek();\n  }\n\n  selectSlot(date: string, slot: any): void {\n    if (slot.is_blocked) return;\n    \n    if (slot.is_available) {\n      this.router.navigate(['/book', date, slot.period]);\n    }\n  }\n\n  getSlotClass(slot: any): string {\n    if (slot.is_blocked) return 'slot-blocked';\n    if (slot.is_available) return 'slot-available';\n    return 'slot-full';\n  }\n\n  getProgressPercent(slot: any): number {\n    if (slot.max_students === 0) return 0;\n    return (slot.current_students / slot.max_students) * 100;\n  }\n\n  getProgressClass(slot: any): string {\n    const percent = this.getProgressPercent(slot);\n    if (percent < 50) return 'bg-success';\n    if (percent < 90) return 'bg-warning';\n    return 'bg-danger';\n  }\n\n  getWeekdayName(weekday: string): string {\n    const days: { [key: string]: string } = {\n      'Monday': 'Montag',\n      'Tuesday': 'Dienstag',\n      'Wednesday': 'Mittwoch',\n      'Thursday': 'Donnerstag',\n      'Friday': 'Freitag',\n      'Saturday': 'Samstag',\n      'Sunday': 'Sonntag'\n    };\n    return days[weekday] || weekday;\n  }\n\n  formatDate(dateStr: string): string {\n    if (!dateStr) return '';\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('de-DE', { \n      day: '2-digit', \n      month: '2-digit', \n      year: 'numeric' \n    });\n  }\n\n  formatDateShort(dateStr: string): string {\n    if (!dateStr) return '';\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('de-DE', { \n      day: '2-digit', \n      month: '2-digit'\n    });\n  }\n\n  formatDateForAPI(date: Date): string {\n    const year = date.getFullYear();\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const day = String(date.getDate()).padStart(2, '0');\n    return `${year}-${month}-${day}`;\n  }\n}\n","size_bytes":9105},"deploy_iserv.sh":{"content":"#!/bin/bash\n# SportOase IServ Deployment Script\n# This script prepares the SportOase module for deployment to IServ\n\nset -e\n\necho \"======================================\"\necho \"SportOase IServ Deployment Preparation\"\necho \"======================================\"\n\n# Configuration\nISERV_DOMAIN=\"${ISERV_DOMAIN:-your-school.iserv.de}\"\nISERV_MODULE_DIR=\"${ISERV_MODULE_DIR:-/usr/share/iserv/modules/sportoase}\"\nBUILD_DIR=\"$(pwd)/build\"\n\necho \"\"\necho \"Configuration:\"\necho \"  IServ Domain: $ISERV_DOMAIN\"\necho \"  Module Directory: $ISERV_MODULE_DIR\"\necho \"  Build Directory: $BUILD_DIR\"\necho \"\"\n\n# Step 1: Install Python dependencies\necho \"[1/6] Installing Python dependencies...\"\npip install -r requirements.txt\n\n# Step 2: Install mysqlclient for MariaDB support\necho \"[2/6] Installing MySQL client for MariaDB...\"\npip install mysqlclient\n\n# Step 3: Install Node.js dependencies\necho \"[3/6] Installing Node.js dependencies...\"\ncd frontend\nnpm install\n\n# Step 4: Build Angular frontend for production\necho \"[4/6] Building Angular frontend for production...\"\nnpm run build -- --configuration production\n\n# Step 5: Collect Django static files\necho \"[5/6] Collecting Django static files...\"\ncd ../backend\nexport DJANGO_SETTINGS_MODULE=backend.settings_prod\nexport DB_ENGINE=sqlite\npython manage.py collectstatic --noinput\n\n# Step 6: Create deployment package\necho \"[6/6] Creating deployment package...\"\ncd ..\nmkdir -p \"$BUILD_DIR\"\ncp -r backend \"$BUILD_DIR/\"\ncp -r frontend/dist/sportoase-frontend \"$BUILD_DIR/frontend_dist\"\ncp module.json \"$BUILD_DIR/\"\ncp requirements.txt \"$BUILD_DIR/\"\ncp README_DEPLOYMENT.md \"$BUILD_DIR/\"\n\necho \"\"\necho \"======================================\"\necho \"Build Complete!\"\necho \"======================================\"\necho \"\"\necho \"Deployment package created in: $BUILD_DIR\"\necho \"\"\necho \"Next steps for IServ deployment:\"\necho \"  1. Copy $BUILD_DIR to your IServ server\"\necho \"  2. Set environment variables in IServ:\"\necho \"       - ISERV_DOMAIN=$ISERV_DOMAIN\"\necho \"       - DB_ENGINE=mysql\"\necho \"       - DB_NAME=iserv_sportoase\"\necho \"       - DB_USER=sportoase\"\necho \"       - DB_PASSWORD=<your-password>\"\necho \"       - DJANGO_SECRET_KEY=<your-secret-key>\"\necho \"       - DEBUG=False\"\necho \"       - HTTPS=True\"\necho \"       - ISERV_AUTH_ENABLED=True\"\necho \"  3. Run migrations: python backend/manage.py migrate --settings=backend.settings_prod\"\necho \"  4. Initialize data: python backend/init_data.py\"\necho \"  5. Configure IServ module permissions\"\necho \"\"\necho \"See README_DEPLOYMENT.md for detailed instructions.\"\necho \"\"\n","size_bytes":2558},"README_DEPLOYMENT.md":{"content":"# SportOase - IServ Deployment Guide\n\n## Prerequisites\n\nBefore deploying SportOase to your IServ environment, ensure you have:\n\n1. **IServ Server Access**: Administrator access to your IServ installation\n2. **Database Access**: MariaDB/MySQL database for SportOase\n3. **Python Environment**: Python 3.10+ installed on IServ\n4. **Node.js**: Node.js 18+ for building the frontend (build server only)\n\n## Deployment Steps\n\n### 1. Prepare the Build\n\nOn your development machine or build server:\n\n```bash\n# Set your IServ domain\nexport ISERV_DOMAIN=your-school.iserv.de\n\n# Run the deployment script\nchmod +x deploy_iserv.sh\n./deploy_iserv.sh\n```\n\nThis creates a `build/` directory with all necessary files.\n\n### 2. Transfer to IServ Server\n\nCopy the build directory to your IServ server:\n\n```bash\nscp -r build/ admin@your-school.iserv.de:/tmp/sportoase\n```\n\n### 3. Configure IServ Environment\n\nOn the IServ server, set up environment variables in `/etc/iserv/sportoase.env`:\n\n```bash\n# IServ Configuration\nISERV_DOMAIN=your-school.iserv.de\nISERV_BASE_URL=https://your-school.iserv.de\nISERV_AUTH_ENABLED=True  # Set to True to enable IServ authentication middleware\n\n# Django Configuration\nDJANGO_SETTINGS_MODULE=backend.settings_prod\nDJANGO_SECRET_KEY=<generate-a-secure-random-key>\nDEBUG=False\nHTTPS=True\n\n# Database Configuration\nDB_ENGINE=mysql\nDB_NAME=iserv_sportoase\nDB_USER=sportoase\nDB_PASSWORD=<secure-database-password>\nDB_HOST=localhost\nDB_PORT=3306\n```\n\n**Generate a secure secret key:**\n```bash\npython -c \"from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())\"\n```\n\n### 4. Create Database\n\nOn the IServ server, create the database and user:\n\n```sql\nCREATE DATABASE iserv_sportoase CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\nCREATE USER 'sportoase'@'localhost' IDENTIFIED BY 'your-secure-password';\nGRANT ALL PRIVILEGES ON iserv_sportoase.* TO 'sportoase'@'localhost';\nFLUSH PRIVILEGES;\n```\n\n### 5. Install Python Dependencies\n\n```bash\ncd /tmp/sportoase\npip3 install -r requirements.txt\npip3 install mysqlclient gunicorn\n```\n\n### 6. Run Database Migrations\n\n```bash\n# Load environment variables\nsource /etc/iserv/sportoase.env\n\n# Run migrations\npython backend/manage.py migrate --settings=backend.settings_prod\n\n# Initialize timeslots\npython backend/init_data.py\n```\n\n### 7. Collect Static Files\n\n```bash\npython backend/manage.py collectstatic --noinput --settings=backend.settings_prod\n```\n\n### 8. Configure IServ Module\n\nCopy the module to IServ's module directory:\n\n```bash\nsudo cp -r /tmp/sportoase /usr/share/iserv/modules/sportoase\nsudo chown -R www-data:www-data /usr/share/iserv/modules/sportoase\n```\n\n### 9. Register Module with IServ\n\nAdd to IServ's module configuration (location varies by IServ version):\n\n```json\n{\n  \"id\": \"sportoase\",\n  \"name\": \"SportOase\",\n  \"enabled\": true,\n  \"path\": \"/usr/share/iserv/modules/sportoase\"\n}\n```\n\n### 10. Configure Permissions\n\nIn IServ Admin Panel → System → Permissions:\n\n1. Create permission group: `sportoase.user`\n   - Assign to: Teachers, Students (as needed)\n   - Description: \"Can book sports facility slots\"\n\n2. Create permission group: `sportoase.admin`\n   - Assign to: Administrators, Sports coordinators\n   - Description: \"Can manage SportOase and block slots\"\n\n### 11. Configure Web Server\n\n#### Apache Configuration\n\nCreate `/etc/apache2/sites-available/sportoase.conf`:\n\n```apache\n<Location /sportoase>\n    ProxyPass http://localhost:8001/sportoase\n    ProxyPassReverse http://localhost:8001/sportoase\n    \n    # Pass IServ authentication headers\n    RequestHeader set X-IServ-User %{ISERV_USER}e\n    RequestHeader set X-IServ-Email %{ISERV_EMAIL}e\n    RequestHeader set X-IServ-Firstname %{ISERV_FIRSTNAME}e\n    RequestHeader set X-IServ-Lastname %{ISERV_LASTNAME}e\n    RequestHeader set X-IServ-Groups %{ISERV_GROUPS}e\n</Location>\n\n<Location /api/sportoase>\n    ProxyPass http://localhost:8001/api/sportoase\n    ProxyPassReverse http://localhost:8001/api/sportoase\n    \n    # Pass IServ authentication headers\n    RequestHeader set X-IServ-User %{ISERV_USER}e\n    RequestHeader set X-IServ-Email %{ISERV_EMAIL}e\n    RequestHeader set X-IServ-Firstname %{ISERV_FIRSTNAME}e\n    RequestHeader set X-IServ-Lastname %{ISERV_LASTNAME}e\n    RequestHeader set X-IServ-Groups %{ISERV_GROUPS}e\n</Location>\n```\n\nEnable and reload:\n```bash\nsudo a2ensite sportoase\nsudo systemctl reload apache2\n```\n\n### 12. Configure Systemd Service\n\nCreate `/etc/systemd/system/sportoase.service`:\n\n```ini\n[Unit]\nDescription=SportOase Gunicorn Service\nAfter=network.target mariadb.service\n\n[Service]\nType=notify\nUser=www-data\nGroup=www-data\nWorkingDirectory=/usr/share/iserv/modules/sportoase\nEnvironmentFile=/etc/iserv/sportoase.env\n\nExecStart=/usr/local/bin/gunicorn \\\n    --bind 127.0.0.1:8001 \\\n    --workers 4 \\\n    --worker-class sync \\\n    --timeout 60 \\\n    --log-file /var/log/sportoase/gunicorn.log \\\n    --access-logfile /var/log/sportoase/access.log \\\n    --error-logfile /var/log/sportoase/error.log \\\n    backend.wsgi:application\n\nExecReload=/bin/kill -s HUP $MAINPID\nKillMode=mixed\nTimeoutStopSec=5\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n```\n\nCreate log directory:\n```bash\nsudo mkdir -p /var/log/sportoase\nsudo chown www-data:www-data /var/log/sportoase\n```\n\nEnable and start:\n```bash\nsudo systemctl daemon-reload\nsudo systemctl enable sportoase\nsudo systemctl start sportoase\nsudo systemctl status sportoase\n```\n\n### 13. Verify Deployment\n\n1. **Check service status:**\n   ```bash\n   sudo systemctl status sportoase\n   ```\n\n2. **Check logs:**\n   ```bash\n   sudo tail -f /var/log/sportoase/gunicorn.log\n   ```\n\n3. **Test API endpoint:**\n   ```bash\n   curl https://your-school.iserv.de/api/sportoase/csrf\n   ```\n\n4. **Access frontend:**\n   Navigate to: `https://your-school.iserv.de/sportoase`\n\n### 14. Post-Deployment Configuration\n\n1. **Create admin user** (if not using IServ auth):\n   ```bash\n   python backend/manage.py createsuperuser --settings=backend.settings_prod\n   ```\n\n2. **Verify permissions:**\n   - Log in as a teacher → Should see booking interface\n   - Log in as admin → Should see admin panel\n\n3. **Test booking flow:**\n   - Create a booking\n   - Verify it appears in database\n   - Test deletion\n   - Test admin blocking features\n\n## IServ Authentication Integration\n\nSportOase integrates with IServ's authentication system through the `IServAuthMiddleware`. \n\n**Important**: The middleware is only activated when `ISERV_AUTH_ENABLED=True` is set in your environment variables. This allows the application to run in development mode (using standard Django auth) or production IServ mode.\n\nThis middleware:\n\n1. Reads user information from IServ request headers\n2. Automatically creates/updates Django users\n3. Syncs IServ group memberships to Django permissions\n\n### Required IServ Headers\n\nEnsure your IServ installation passes these headers:\n\n- `X-IServ-User`: Username\n- `X-IServ-Email`: Email address\n- `X-IServ-Firstname`: First name\n- `X-IServ-Lastname`: Last name\n- `X-IServ-Groups`: Comma-separated group list\n\n### Permission Mapping\n\n| IServ Group | Django Permission | Description |\n|------------|-------------------|-------------|\n| `lehrer`, `teachers` | `sportoase.user` | Can book slots |\n| `admin`, `administrators` | `sportoase.admin` | Can manage system |\n\n## Troubleshooting\n\n### Database Connection Issues\n\n```bash\n# Test database connection\nmysql -u sportoase -p iserv_sportoase -e \"SHOW TABLES;\"\n\n# Check Django database connection\npython backend/manage.py dbshell --settings=backend.settings_prod\n```\n\n### Service Won't Start\n\n```bash\n# Check detailed logs\nsudo journalctl -u sportoase -n 50 --no-pager\n\n# Test gunicorn manually\nsource /etc/iserv/sportoase.env\ngunicorn --bind 127.0.0.1:8001 backend.wsgi:application\n```\n\n### Frontend Not Loading\n\n1. Check static files are collected:\n   ```bash\n   ls -la /usr/share/iserv/modules/sportoase/staticfiles/\n   ```\n\n2. Verify Apache proxy configuration:\n   ```bash\n   sudo apache2ctl configtest\n   ```\n\n3. Check browser console for errors\n\n### Authentication Not Working\n\n1. Verify IServ headers are being passed:\n   ```bash\n   # Add to a view temporarily:\n   print(request.META)\n   ```\n\n2. Check middleware is enabled in settings:\n   ```python\n   ISERV_AUTH_ENABLED = True\n   ```\n\n3. Verify permissions are created:\n   ```bash\n   python backend/manage.py shell --settings=backend.settings_prod\n   >>> from django.contrib.auth.models import Permission\n   >>> Permission.objects.filter(codename__in=['user', 'admin'])\n   ```\n\n## Backup and Maintenance\n\n### Database Backup\n\n```bash\n# Create backup\nmysqldump -u sportoase -p iserv_sportoase > sportoase_backup_$(date +%Y%m%d).sql\n\n# Restore backup\nmysql -u sportoase -p iserv_sportoase < sportoase_backup_20250120.sql\n```\n\n### Update Deployment\n\n```bash\n# Stop service\nsudo systemctl stop sportoase\n\n# Backup database\nmysqldump -u sportoase -p iserv_sportoase > backup.sql\n\n# Pull updates\ncd /usr/share/iserv/modules/sportoase\ngit pull  # If using git\n\n# Run migrations\npython backend/manage.py migrate --settings=backend.settings_prod\n\n# Collect static files\npython backend/manage.py collectstatic --noinput --settings=backend.settings_prod\n\n# Restart service\nsudo systemctl start sportoase\n```\n\n### Log Rotation\n\nCreate `/etc/logrotate.d/sportoase`:\n\n```\n/var/log/sportoase/*.log {\n    daily\n    missingok\n    rotate 14\n    compress\n    delaycompress\n    notifempty\n    create 0640 www-data www-data\n    sharedscripts\n    postrotate\n        systemctl reload sportoase > /dev/null 2>&1 || true\n    endscript\n}\n```\n\n## Security Checklist\n\n- [ ] `DEBUG = False` in production\n- [ ] Secure `DJANGO_SECRET_KEY` generated and set\n- [ ] Database password is strong and unique\n- [ ] `HTTPS = True` for secure cookies\n- [ ] CSRF trusted origins configured correctly\n- [ ] File permissions set correctly (www-data:www-data)\n- [ ] Firewall configured (only necessary ports open)\n- [ ] Regular database backups configured\n- [ ] Log rotation configured\n- [ ] Security updates applied regularly\n\n## Support\n\nFor issues or questions:\n\n1. Check the logs: `/var/log/sportoase/`\n2. Review IServ documentation: https://doku.iserv.de/\n3. Check Django documentation: https://docs.djangoproject.com/\n\n## License\n\nSportOase is licensed under [Your License]. See LICENSE file for details.\n","size_bytes":10327},"backend/middleware/__init__.py":{"content":"","size_bytes":0},"backend/views/auth.py":{"content":"from django.http import JsonResponse, HttpResponseForbidden\nfrom django.views.decorators.http import require_http_methods\nfrom django.contrib.auth import authenticate, login, logout\nfrom django.views.decorators.csrf import csrf_exempt\nimport json\n\n\n@csrf_exempt\n@require_http_methods([\"POST\"])\ndef login_view(request):\n    \"\"\"POST /api/sportoase/login - Development login endpoint\"\"\"\n    try:\n        data = json.loads(request.body)\n        username = data.get('username')\n        password = data.get('password')\n        \n        if not username or not password:\n            return JsonResponse({'error': 'Benutzername und Passwort erforderlich'}, status=400)\n        \n        user = authenticate(request, username=username, password=password)\n        \n        if user is not None:\n            login(request, user)\n            return JsonResponse({\n                'success': True,\n                'user': {\n                    'username': user.username,\n                    'is_staff': user.is_staff,\n                    'permissions': list(user.get_all_permissions())\n                }\n            })\n        else:\n            return JsonResponse({'error': 'Ungültige Anmeldedaten'}, status=401)\n            \n    except Exception as e:\n        return JsonResponse({'error': str(e)}, status=500)\n\n\n@require_http_methods([\"POST\"])\ndef logout_view(request):\n    \"\"\"POST /api/sportoase/logout - Logout endpoint\"\"\"\n    logout(request)\n    return JsonResponse({'success': True})\n\n\n@require_http_methods([\"GET\"])\ndef check_auth(request):\n    \"\"\"GET /api/sportoase/check-auth - Check authentication status\"\"\"\n    if request.user.is_authenticated:\n        return JsonResponse({\n            'authenticated': True,\n            'user': {\n                'username': request.user.username,\n                'is_staff': request.user.is_staff,\n                'permissions': list(request.user.get_all_permissions())\n            }\n        })\n    return JsonResponse({'authenticated': False})\n","size_bytes":1978},"backend/middleware/iserv_auth.py":{"content":"from django.contrib.auth.models import User\nfrom django.conf import settings\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n\nclass IServAuthMiddleware:\n    \"\"\"\n    Middleware for IServ authentication integration.\n    \n    When deployed in IServ, this middleware handles authentication by:\n    1. Reading user information from IServ's request headers/session\n    2. Creating or updating Django User objects based on IServ user data\n    3. Syncing IServ permissions to Django permissions\n    \n    For development/testing outside IServ, it falls back to standard Django auth.\n    \"\"\"\n    \n    def __init__(self, get_response):\n        self.get_response = get_response\n        self.enabled = getattr(settings, 'ISERV_AUTH_ENABLED', False)\n    \n    def __call__(self, request):\n        if self.enabled and not request.user.is_authenticated:\n            self._authenticate_iserv_user(request)\n        \n        response = self.get_response(request)\n        return response\n    \n    def _authenticate_iserv_user(self, request):\n        \"\"\"\n        Authenticate user based on IServ session/headers.\n        \n        IServ typically provides user information via:\n        - HTTP_X_ISERV_USER: Username\n        - HTTP_X_ISERV_EMAIL: Email address\n        - HTTP_X_ISERV_FIRSTNAME: First name\n        - HTTP_X_ISERV_LASTNAME: Last name\n        - HTTP_X_ISERV_GROUPS: Comma-separated list of groups\n        \n        Adjust header names based on your IServ configuration.\n        \"\"\"\n        username = request.META.get('HTTP_X_ISERV_USER')\n        \n        if not username:\n            return\n        \n        try:\n            user, created = User.objects.get_or_create(\n                username=username,\n                defaults={\n                    'email': request.META.get('HTTP_X_ISERV_EMAIL', ''),\n                    'first_name': request.META.get('HTTP_X_ISERV_FIRSTNAME', ''),\n                    'last_name': request.META.get('HTTP_X_ISERV_LASTNAME', ''),\n                }\n            )\n            \n            if not created:\n                user.email = request.META.get('HTTP_X_ISERV_EMAIL', user.email)\n                user.first_name = request.META.get('HTTP_X_ISERV_FIRSTNAME', user.first_name)\n                user.last_name = request.META.get('HTTP_X_ISERV_LASTNAME', user.last_name)\n                user.save()\n            \n            self._sync_permissions(user, request)\n            \n            from django.contrib.auth import login\n            login(request, user, backend='django.contrib.auth.backends.ModelBackend')\n            \n            logger.info(f\"IServ user authenticated: {username}\")\n            \n        except Exception as e:\n            logger.error(f\"IServ authentication error: {str(e)}\")\n    \n    def _sync_permissions(self, user, request):\n        \"\"\"\n        Sync IServ groups/permissions to Django user permissions.\n        \n        Maps IServ groups to Django permissions:\n        - Teachers -> sportoase.user permission\n        - Admins -> sportoase.admin permission\n        \"\"\"\n        from django.contrib.auth.models import Permission\n        from django.contrib.contenttypes.models import ContentType\n        \n        iserv_groups = request.META.get('HTTP_X_ISERV_GROUPS', '').split(',')\n        iserv_groups = [g.strip().lower() for g in iserv_groups if g.strip()]\n        \n        try:\n            content_type = ContentType.objects.get(app_label='backend', model='booking')\n            \n            if 'lehrer' in iserv_groups or 'teachers' in iserv_groups:\n                perm, _ = Permission.objects.get_or_create(\n                    codename='user',\n                    name='Can use SportOase',\n                    content_type=content_type\n                )\n                user.user_permissions.add(perm)\n            \n            if 'admin' in iserv_groups or 'administrators' in iserv_groups:\n                perm, _ = Permission.objects.get_or_create(\n                    codename='admin',\n                    name='Can administer SportOase',\n                    content_type=content_type\n                )\n                user.user_permissions.add(perm)\n                \n                admin_perm, _ = Permission.objects.get_or_create(\n                    codename='user',\n                    name='Can use SportOase',\n                    content_type=content_type\n                )\n                user.user_permissions.add(admin_perm)\n            \n        except Exception as e:\n            logger.error(f\"Error syncing permissions: {str(e)}\")\n","size_bytes":4509},"backend/settings_prod.py":{"content":"import os\nfrom pathlib import Path\n\nBASE_DIR = Path(__file__).resolve().parent.parent\n\nSECRET_KEY = os.environ.get('DJANGO_SECRET_KEY', os.environ.get('SESSION_SECRET', 'CHANGE-THIS-IN-PRODUCTION'))\n\nDEBUG = os.environ.get('DEBUG', 'False') == 'True'\n\nISERV_DOMAIN = os.environ.get('ISERV_DOMAIN', 'localhost')\nALLOWED_HOSTS = [ISERV_DOMAIN, f'*.{ISERV_DOMAIN}', 'localhost', '127.0.0.1']\n\nINSTALLED_APPS = [\n    'django.contrib.admin',\n    'django.contrib.auth',\n    'django.contrib.contenttypes',\n    'django.contrib.sessions',\n    'django.contrib.messages',\n    'django.contrib.staticfiles',\n    'rest_framework',\n    'corsheaders',\n    'backend',\n]\n\nMIDDLEWARE = [\n    'django.middleware.security.SecurityMiddleware',\n    'django.contrib.sessions.middleware.SessionMiddleware',\n    'corsheaders.middleware.CorsMiddleware',\n    'django.middleware.common.CommonMiddleware',\n    'django.middleware.csrf.CsrfViewMiddleware',\n    'django.contrib.auth.middleware.AuthenticationMiddleware',\n    'django.contrib.messages.middleware.MessageMiddleware',\n    'django.middleware.clickjacking.XFrameOptionsMiddleware',\n]\n\nif os.environ.get('ISERV_AUTH_ENABLED', 'False') == 'True':\n    MIDDLEWARE.insert(\n        MIDDLEWARE.index('django.contrib.messages.middleware.MessageMiddleware'),\n        'backend.middleware.iserv_auth.IServAuthMiddleware'\n    )\n\nROOT_URLCONF = 'backend.main_urls'\n\nTEMPLATES = [\n    {\n        'BACKEND': 'django.template.backends.django.DjangoTemplates',\n        'DIRS': [BASE_DIR / 'templates'],\n        'APP_DIRS': True,\n        'OPTIONS': {\n            'context_processors': [\n                'django.template.context_processors.debug',\n                'django.template.context_processors.request',\n                'django.contrib.auth.context_processors.auth',\n                'django.contrib.messages.context_processors.messages',\n            ],\n        },\n    },\n]\n\nWSGI_APPLICATION = 'backend.wsgi.application'\n\ndb_engine = os.environ.get('DB_ENGINE', 'sqlite')\n\nif db_engine == 'mysql':\n    DATABASES = {\n        'default': {\n            'ENGINE': 'django.db.backends.mysql',\n            'NAME': os.environ.get('DB_NAME', 'iserv_sportoase'),\n            'USER': os.environ.get('DB_USER', 'sportoase'),\n            'PASSWORD': os.environ.get('DB_PASSWORD', ''),\n            'HOST': os.environ.get('DB_HOST', 'localhost'),\n            'PORT': os.environ.get('DB_PORT', '3306'),\n            'OPTIONS': {\n                'charset': 'utf8mb4',\n                'init_command': \"SET sql_mode='STRICT_TRANS_TABLES'\",\n            },\n        }\n    }\nelse:\n    DATABASES = {\n        'default': {\n            'ENGINE': 'django.db.backends.sqlite3',\n            'NAME': BASE_DIR / 'db.sqlite3',\n        }\n    }\n\nAUTH_PASSWORD_VALIDATORS = [\n    {\n        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',\n    },\n    {\n        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',\n    },\n]\n\nLANGUAGE_CODE = 'de-de'\nTIME_ZONE = 'Europe/Berlin'\nUSE_I18N = True\nUSE_TZ = True\n\nSTATIC_URL = '/static/'\nSTATIC_ROOT = BASE_DIR / 'staticfiles'\n\nDEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'\n\nis_https = os.environ.get('HTTPS', 'True') == 'True'\nCSRF_COOKIE_SECURE = is_https\nSESSION_COOKIE_SECURE = is_https\nCSRF_COOKIE_HTTPONLY = True\nCSRF_COOKIE_SAMESITE = 'Lax'\n\nISERV_BASE_URL = os.environ.get('ISERV_BASE_URL', f'https://{ISERV_DOMAIN}')\n\nCSRF_TRUSTED_ORIGINS = [\n    ISERV_BASE_URL,\n    'http://localhost:4200',\n    'http://localhost:5000',\n]\n\nCORS_ALLOW_ALL_ORIGINS = DEBUG\nCORS_ALLOW_CREDENTIALS = True\nCORS_ALLOWED_ORIGINS = [\n    ISERV_BASE_URL,\n    'http://localhost:4200',\n    'http://127.0.0.1:4200',\n]\n\nREST_FRAMEWORK = {\n    'DEFAULT_AUTHENTICATION_CLASSES': [\n        'rest_framework.authentication.SessionAuthentication',\n    ],\n    'DEFAULT_PERMISSION_CLASSES': [\n        'rest_framework.permissions.IsAuthenticated',\n    ],\n}\n\nPERIOD_TIMES = {\n    1: {'start': '08:00', 'end': '08:45'},\n    2: {'start': '08:50', 'end': '09:35'},\n    3: {'start': '09:55', 'end': '10:40'},\n    4: {'start': '10:45', 'end': '11:30'},\n    5: {'start': '11:50', 'end': '12:35'},\n    6: {'start': '12:40', 'end': '13:25'},\n}\n\nLOGGING = {\n    'version': 1,\n    'disable_existing_loggers': False,\n    'handlers': {\n        'file': {\n            'level': 'INFO',\n            'class': 'logging.FileHandler',\n            'filename': BASE_DIR / 'sportoase.log',\n        },\n        'console': {\n            'class': 'logging.StreamHandler',\n        },\n    },\n    'loggers': {\n        'django': {\n            'handlers': ['file', 'console'],\n            'level': 'INFO',\n        },\n        'backend': {\n            'handlers': ['file', 'console'],\n            'level': 'DEBUG' if DEBUG else 'INFO',\n        },\n    },\n}\n","size_bytes":4773}},"version":2}